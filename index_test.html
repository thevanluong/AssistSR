<!DOCTYPE html>
<html lang="fr" data-theme="sky">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Doggygo ¬∑ Palette Pro (stable)</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* ==========================================================
   CHAT STANDARD ‚Äî solide & compatible (sans color-mix exotique)
   - 1 colonne (mobile & desktop)
   - Options multi‚Äëligne sans c√©sure (iOS/Android OK)
   - Cartes en cascade
   - Palette s√©lecteur (5 th√®mes)
   ========================================================== */

/* === Th√®mes ========================================================= */
:root{
  --ink:#0b1b2a; --muted:#667487; --line:#e6edf3; --panel:#ffffff;
  --bg-1:#f7fafc; --bg-2:#f5f9ff;
  --accent:#0ea5e9; --accent-2:#7dd3fc; --accent-3:#e0f2fe; --ring: rgba(14,165,233,.28);
}
html[data-theme="sky"]    { --ink:#0b1b2a; --muted:#667487; --line:#e6edf3; --panel:#fff; --bg-1:#f6fafe; --bg-2:#eef7ff; --accent:#0ea5e9; --accent-2:#7dd3fc; --accent-3:#e0f2fe; --ring: rgba(14,165,233,.28); }
html[data-theme="emerald"]{ --ink:#0a1814; --muted:#5f706a; --line:#e3eee9; --panel:#fff; --bg-1:#f5fbf8; --bg-2:#f2fbf6; --accent:#10b981; --accent-2:#6ee7b7; --accent-3:#d1fae5; --ring: rgba(16,185,129,.28); }
html[data-theme="amber"]  { --ink:#1a1307; --muted:#766a55; --line:#efe7d7; --panel:#fff; --bg-1:#fdfaf3; --bg-2:#fcf7eb; --accent:#f59e0b; --accent-2:#fcd34d; --accent-3:#fef3c7; --ring: rgba(245,158,11,.28); }
html[data-theme="violet"] { --ink:#161127; --muted:#6a6785; --line:#e8e6f4; --panel:#fff; --bg-1:#f8f7fe; --bg-2:#f6f5fd; --accent:#8b5cf6; --accent-2:#c4b5fd; --accent-3:#ede9fe; --ring: rgba(139,92,246,.28); }
html[data-theme="unil"]   { --ink:#0a1f30; --muted:#6a7883; --line:#e2e9ee; --panel:#fff; --bg-1:#f7fafc; --bg-2:#f5f9ff; --accent:#008ccc; --accent-2:#b3ddef; --accent-3:#e7f4fb; --ring: rgba(0,140,204,.28); }

/* === Layout ========================================================= */
*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0; color:var(--ink);
  font:400 clamp(14px,1.05vw,16px)/1.6 Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Roboto, Arial, sans-serif;
  -webkit-text-size-adjust:100%; -webkit-font-smoothing:antialiased;
  background:
    radial-gradient(60vw 40vh at -10% -10%, rgba(0,0,0,.03), transparent 60%),
    radial-gradient(50vw 40vh at 110% 0%, rgba(0,0,0,.02), transparent 60%),
    linear-gradient(180deg, var(--bg-1), var(--bg-2));
  padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
}
.container{ max-width:920px; margin:0 auto; padding:clamp(12px,3vw,24px) }

/* Header + paletteur */
.header{ display:flex; align-items:center; justify-content:space-between; gap:12px }
.brand{ display:flex; align-items:center; gap:12px }
.logo{ width:46px; height:46px; border-radius:13px; object-fit:cover; box-shadow:0 10px 28px rgba(12,27,42,.06) }
.title{ margin:0; font-weight:800; font-size:clamp(17px,1.45vw,20px) }
.sub{ margin:2px 0 0; color:var(--muted); font-size:clamp(13.5px,1vw,14px) }

.tools{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap }
.tools a{
  text-decoration:none; color:inherit; font-weight:700; font-size:clamp(13.5px,1vw,14px);
  padding:.5rem .9rem; border-radius:999px; background:#fff; border:1px solid var(--line);
  box-shadow:0 4px 10px rgba(12,27,42,.05)
}
.tools a:focus{ outline:none; box-shadow:0 0 0 .28rem var(--ring) }

.theme-picker{ display:flex; gap:.35rem; align-items:center }
.theme-chip{
  width:26px; height:26px; border-radius:999px; border:1px solid var(--line); cursor:pointer;
  box-shadow:0 4px 10px rgba(12,27,42,.06);
}
.theme-chip[data-t="sky"]    { background:linear-gradient(180deg,#e0f2fe,#7dd3fc) }
.theme-chip[data-t="emerald"]{ background:linear-gradient(180deg,#d1fae5,#6ee7b7) }
.theme-chip[data-t="amber"]  { background:linear-gradient(180deg,#fef3c7,#fcd34d) }
.theme-chip[data-t="violet"] { background:linear-gradient(180deg,#ede9fe,#c4b5fd) }
.theme-chip[data-t="unil"]   { background:linear-gradient(180deg,#e7f4fb,#b3ddef) }
.theme-chip[aria-current="true"]{ outline:2px solid var(--accent) }

/* Panel */
.chat{
  margin-top:14px; border-radius:18px;
  background:
    linear-gradient(#fff,#fff) padding-box,
    linear-gradient(120deg, var(--accent), #ffffff, var(--accent-2)) border-box;
  border:1px solid transparent; box-shadow:0 26px 64px rgba(12,27,42,.10); overflow:clip;
}
.bar{
  display:flex; gap:.4rem; align-items:center; padding:10px 12px;
  background:linear-gradient(180deg,#fff,#fbfdff); border-bottom:1px solid var(--line);
}
.dot{
  width:24px; height:24px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center;
  font:800 clamp(13.5px,1vw,14px)/1 Inter,sans-serif; color:#074a6d;
  background:#f3f9ff; border:1px solid #d9eaf6;
}
.dot:last-child{ border-image:linear-gradient(120deg,var(--accent),var(--accent-2)) 1 }

/* Messages */
.feed{ padding:12px }
.msg{ display:flex; align-items:flex-start; gap:10px; margin:12px 0 }
.avatar{
  width:28px; height:28px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800;
  background:linear-gradient(180deg,#eaf6ff,#f7fbff); color:#0a6ea0; border:1px solid var(--line); font-size:15px; flex:0 0 auto;
}
.msg.user .avatar{ background:linear-gradient(180deg,#f6f8fb,#fff); color:#24313b }

.bubble{
  width:100%; max-width:100%;
  border-radius:14px; background:linear-gradient(180deg,#fff,#fbfdff);
  border:1px solid var(--line); box-shadow:inset 0 1px 0 var(--accent-3), 0 1px 0 rgba(12,27,42,.03);
  padding:12px 14px; line-height:1.6; font-size:clamp(14px,1.05vw,16px);
}
.bubble .title{ font-weight:800; margin-bottom:8px; font-size:clamp(16px,1.25vw,18px) }

/* Options */
.list{ margin-top:10px }
.stack{ display:flex; flex-direction:column; gap:10px }  /* 1 colonne */

.card{
  position:relative; display:grid; grid-template-columns:auto minmax(0,1fr) auto; align-items:center; column-gap:12px;
  border-radius:16px; padding:14px 16px; min-height:58px;
  background:linear-gradient(180deg,#ffffff,#fbfdff);
  border:1px solid var(--line);
  box-shadow:0 1px 0 rgba(12,27,42,.02);
  text-decoration:none; color:inherit; font-weight:800; font-size:clamp(14px,1.05vw,16px);
  transform:translateY(6px); opacity:0; will-change:transform,opacity; overflow:hidden;
}
.card::before{
  content:""; position:absolute; left:-1px; top:-1px; bottom:-1px; width:6px; border-radius:16px 0 0 16px;
  background:linear-gradient(180deg, var(--accent), var(--accent-2));
  opacity:.9;
}
.card.reveal{ opacity:1; transform:translateY(0); transition:transform .16s ease, opacity .16s ease }
.card:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(12,27,42,.08); border-color:#dbe9f6 }
.ic{
  width:36px; height:36px; border-radius:11px; display:flex; align-items:center; justify-content:center;
  background:linear-gradient(180deg, var(--accent-3), #fff);
  border:1px solid #deebf5;
  color:#0a6ea0;
  box-shadow:inset 0 1px 0 #fff, 0 6px 16px rgba(10,110,160,.18);
}
/* Libell√© multi‚Äëligne, sans c√©sure auto */
.label, .label > span{
  min-width:0; display:block; white-space:normal; word-break:normal; overflow-wrap:break-word;
  -webkit-hyphens:manual; hyphens:manual; line-height:1.35;
}
.arr{ color:var(--muted); justify-self:end }

/* Actions */
.actions{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:10px }
.btn{
  text-decoration:none; color:inherit; font-weight:700; font-size:clamp(13.5px,1vw,14px);
  padding:.5rem .9rem; border-radius:999px; background:#fff; border:1px solid var(--line);
  box-shadow:0 4px 10px rgba(12,27,42,.05)
}
.btn:focus{ outline:none; box-shadow:0 0 0 .28rem var(--ring) }

/* Contact */
.contact{
  display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center;
  border:1px solid var(--line); border-radius:16px; padding:14px; margin-top:12px;
  background:linear-gradient(180deg,#ffffff,#fbfdff); box-shadow:0 14px 32px rgba(12,27,42,.08);
}
.contact .ava{
  width:56px; height:56px; border-radius:14px; display:flex; align-items:center; justify-content:center;
  background:linear-gradient(180deg, var(--accent), var(--accent-2));
  color:#fff; font-weight:900; border:1px solid rgba(0,0,0,.02); font-size:18px;
  box-shadow:0 10px 20px rgba(10,110,160,.20);
}
.contact .name{ font-weight:800; font-size:clamp(14px,1.05vw,16px) }
.contact .meta{ color:var(--muted); font-size:clamp(13.5px,1vw,14px) }
.contact .cta{
  text-decoration:none; color:#003a57;
  background:linear-gradient(90deg, var(--accent), var(--accent-2));
  padding:.65rem 1rem; border-radius:999px; font-weight:900; font-size:clamp(13.5px,1vw,14px); border:0;
  box-shadow:0 12px 24px rgba(10,110,160,.24);
}
@media (max-width:640px){ .contact{ grid-template-columns:1fr } .contact .cta{ width:100%; text-align:center } }

/* Note & debug */
.note{ color:var(--muted); font-size:clamp(13.5px,1vw,14px); padding:10px 12px; border-top:1px solid var(--line);
  background:linear-gradient(180deg,#ffffff,#fbfdff) }
.alert{
  color:#b42318; background:#fff5f5; border:1px solid #ffd4d4; padding:10px 12px; border-radius:12px; font-weight:700;
}
.debug{
  margin:8px 0 0; font-size:12px; color:#6b7280;
}

/* Skeleton loader */
.skel{ height:14px; background:linear-gradient(90deg,#eef3f8,#f6fafd,#eef3f8); background-size:200% 100%;
  animation:shimmer 1.1s linear infinite; border-radius:6px; margin:6px 0 }
@keyframes shimmer { 0%{background-position:0 0} 100%{background-position:-200% 0} }

@media (prefers-reduced-motion:reduce){ .card{ transition:none !important; transform:none !important; opacity:1 !important; } .skel{ animation:none } }
</style>
</head>

<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <img src="doggygo.png" class="logo" alt="">
        <div>
          <p class="title">Doggygo</p>
          <p class="sub">Assistant du Service de la recherche</p>
        </div>
      </div>

      <div class="tools" id="top-tools" style="display:none">
        <div class="theme-picker" aria-label="Choisir un th√®me de couleurs">
          <button class="theme-chip" data-t="sky"    title="Sky"></button>
          <button class="theme-chip" data-t="emerald" title="Emerald"></button>
          <button class="theme-chip" data-t="amber"  title="Amber"></button>
          <button class="theme-chip" data-t="violet" title="Violet"></button>
          <button class="theme-chip" data-t="unil"   title="UNIL"></button>
        </div>
        <a id="back" href="javascript:goback();" style="display:none">‚Üê Retour</a>
        <a id="restart" href="javascript:location.reload()" style="display:none">‚ü≤ Recommencer</a>
      </div>
    </header>

    <section class="chat">
      <div class="bar" id="progress" aria-live="polite"></div>
      <div class="feed" id="feed" aria-live="polite" aria-label="Flux de conversation">
        <!-- Loader visuel avant les donn√©es -->
        <div class="msg assistant" id="boot-skel">
          <div class="avatar" aria-hidden="true">üêæ</div>
          <div class="bubble">
            <div class="skel" style="width:68%"></div>
            <div class="skel" style="width:38%"></div>
          </div>
        </div>
      </div>
      <div class="note"><i class="fa-regular fa-circle-question"></i> Les liens de contact pointent vers l‚Äôannuaire UNIL.</div>
    </section>
  </div>

<script>
/* ==========================================================
   JS ‚Äî dynamique rapide + multi‚Äëchemins + fallback + logs
   ========================================================== */
const SPEED = { CHAR_MS: 7, STAGGER_MS: 26 };

var lang="fr";
var papagoUrl = "./trees/";   // valeur par d√©faut, mais on tente plusieurs chemins
var persons={
  "EAM":{ "name":"Eliane Abou Mansour","url":"https://annuaire.unil.ch/person/LgLLf7wep3kZBi" },
  "VL":{ "name":"V√©ronique Longchamp","url":"https://annuaire.unil.ch/person/u5rsd2fbRe7LFH" },
  "AEDC":{ "name":"Anne-Emmanuelle de Crousaz","url":"https://annuaire.unil.ch/person/R87FcLkKew3U7p" },
  "AB":{ "name":"Aur√©lie Brehmer","url":"https://annuaire.unil.ch/person/hk2dAGXkGb4U5w" },
  "CA":{ "name":"Claire Arnold","url":"https://annuaire.unil.ch/person/47c7LgpckuHb25" },
  "ZEM":{ "name":"Zohra El Masbahi","url":"https://annuaire.unil.ch/person/KGKZjmZikDrmpw" },
  "ACB":{ "name":"Anne-Christine Butty","url":"https://annuaire.unil.ch/person/LjB3d7wep3kZBi" },
  "MD":{ "name":"Ma√´lle Desard","url":"https://annuaire.unil.ch/person/hkifyGXkGb4U5w" },
  "PAD":{ "name":"Pablo Andr√©s Diaz","url":"https://annuaire.unil.ch/person/pfFzXB2bjLZnA4" },
  "TVL":{ "name":"Th√© Van Luong","url":"https://annuaire.unil.ch/person/cmbpD4u7m9XUBj" },
  "MC":{ "name":"Micaela Crespo","url":"https://annuaire.unil.ch/person/cKu9p4u7m9XUBj" },
  "LC":{ "name":"Lucia Couto","url":"https://annuaire.unil.ch/person/p9L8fB2bjLZnA4" },
  "JR":{ "name":"Julian Randall","url":"https://annuaire.unil.ch/person/R4rszLkKew3U7p" }
};
var translate={
  "fr":{ "contact":"Contacter","text":"La personne ci‚Äëdessous peut vous conseiller directement.","error":"Doggygo n'est pas accessible pour le moment." },
  "en":{ "contact":"Contact","text":"This person can advise you directly.","error":"Doggygo is not available at the moment." }
};

/* Fallback minimal pour tester l‚ÄôUI si les JSON ne chargent pas */
const FALLBACK_TREE={
  "0":{
    "label":"Exemple de d√©monstration ‚Äî vos donn√©es ne se chargent pas encore.",
    "options":[
      {"option":"Administration (exemple)","value":"Contacter VL"},
      {"option":"Aller √† une sous‚Äëquestion (exemple)","value":"1"}
    ]
  },
  "1":{
    "label":"Ceci est un n≈ìud local de test. Quand vos JSON seront trouv√©s, ce message dispara√Ætra.",
    "parent":"0",
    "options":[
      {"option":"Retour √† l‚Äôaccueil","value":"0"},
      {"option":"Contacter un exemple","value":"Contacter EAM"}
    ]
  }
};

var papago={}, currentKey="", parentKey="", atContact=false, backFromContact="", trail=[];
const $=s=>document.querySelector(s);
function setHTML(t,h){(typeof t==="string"?$(t):t).innerHTML=h;}
function show(el){if(el) el.style.display="";}
function hide(el){if(el) el.style.display="none";}
function escapeHTML(s){const d=document.createElement('div'); d.textContent=String(s||""); return d.innerHTML;}
function initials(n){if(!n) return "?"; const p=n.trim().split(/\s+/); return ((p[0]?.[0]||"")+(p[1]?.[0]||"")).toUpperCase()||"?";}
function scrollToBottom(){requestAnimationFrame(()=>window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}));}
function reduced(){return window.matchMedia&&window.matchMedia('(prefers-reduced-motion: reduce)').matches;}

/* Progress */
function renderProgress(){
  const el=$("#progress"); if(!el) return;
  if(!trail.length){el.innerHTML=""; return;}
  el.innerHTML=trail.map((_,i)=>`<span class="dot">${i+1}</span>`).join("");
}

/* Messages */
function addAssistantBubble(){
  const item=document.createElement('div');
  item.className="msg assistant";
  item.innerHTML=`<div class="avatar" aria-hidden="true">üêæ</div>
    <div class="bubble"><div class="text"></div><div class="list"></div></div>`;
  $("#feed").appendChild(item); scrollToBottom(); return item;
}
function addUserBubble(){
  const item=document.createElement('div');
  item.className="msg user";
  item.innerHTML=`<div class="avatar" aria-hidden="true"></div><div class="bubble"><span class="typed"></span></div>`;
  $("#feed").appendChild(item); scrollToBottom(); return item;
}

/* Typing rapide */
function typeChars(el,text,ms){
  if(reduced()){ el.textContent=text; return Promise.resolve(); }
  return new Promise(res=>{
    const span=document.createElement('span'); el.appendChild(span);
    let i=0; (function loop(){ if(i<text.length){ span.textContent+=text.charAt(i++); setTimeout(loop,ms); scrollToBottom(); } else res(); })();
  });
}

/* Options */
function createCard(opt){
  const a=document.createElement('a');
  a.href="javascript:void(0)"; a.className="card";
  a.setAttribute('title', opt.option); a.setAttribute('aria-label', opt.option);
  a.innerHTML=`
    <div class="ic"><i class="fa-solid fa-bolt"></i></div>
    <div class="label"><span>${escapeHTML(opt.option)}</span></div>
    <div class="arr"><i class="fa-solid fa-chevron-right"></i></div>`;
  a.onclick=()=> choose(opt.value,opt.option,a);
  return a;
}
function revealCards(stack, options){
  options.forEach((opt,idx)=>{
    const card=createCard(opt); stack.appendChild(card);
    setTimeout(()=> card.classList.add('reveal'), idx*SPEED.STAGGER_MS);
  });
}

/* √âtapes */
async function renderOptions(key){
  const node=papago[key]||{}; const label=String(node.label||"");
  parentKey=node.parent||""; currentKey=key; atContact=false;

  if(trail[trail.length-1]!==key) trail.push(key); renderProgress();

  const msg=addAssistantBubble();
  await typeChars(msg.querySelector('.text'), label, SPEED.CHAR_MS);

  const stack=document.createElement('div'); stack.className="stack";
  msg.querySelector('.list').appendChild(stack);
  revealCards(stack, node.options||[]);

  const actions=document.createElement('div'); actions.className="actions";
  if(node.parent){
    const back=document.createElement('a'); back.className="btn"; back.href="javascript:goback()"; back.textContent="‚Üê Retour"; actions.appendChild(back);
  }
  msg.querySelector('.bubble').appendChild(actions);

  show($("#top-tools")); node.parent?show($("#back")):hide($("#back")); hide($("#restart")); scrollToBottom();
}

async function renderContact(value){
  const code=(value.split(" ")[1]||"").trim(); const p=persons[code]||{};
  const name=p.name||code||"Contact"; const url=p.url||"#";

  backFromContact=currentKey; atContact=true;
  if(trail[trail.length-1]!=="contact:"+code) trail.push("contact:"+code); renderProgress();

  const msg=addAssistantBubble();
  await typeChars(msg.querySelector('.text'), translate[lang]["text"], SPEED.CHAR_MS);

  const card=document.createElement('div'); card.className="contact";
  card.innerHTML=`<div class="ava">${initials(name)}</div>
    <div><div class="name">${escapeHTML(name)}</div>
    <div class="meta"><i class="fa-regular fa-address-card"></i> UNIL ¬∑ Service de la recherche</div></div>
    <div><a class="cta" target="_blank" rel="noopener" href="${url}"><i class="fa-solid fa-paper-plane"></i> ${escapeHTML(translate[lang]["contact"])}</a></div>`;
  msg.querySelector('.text').appendChild(card);

  const actions=document.createElement('div'); actions.className="actions";
  const back=document.createElement('a'); back.className="btn"; back.href="javascript:goback()"; back.textContent="‚Üê Retour"; actions.appendChild(back);
  const restart=document.createElement('a'); restart.className="btn"; restart.href="javascript:location.reload()"; restart.textContent="‚ü≤ Recommencer"; actions.appendChild(restart);
  msg.querySelector('.bubble').appendChild(actions);

  show($("#top-tools")); show($("#back")); show($("#restart")); scrollToBottom();
}

/* Choix */
async function choose(value,label,card){
  const stack=card.parentElement; Array.from(stack.children).forEach(c=>{ c.style.pointerEvents="none"; c.style.opacity=.65; });
  const user=addUserBubble(); await typeChars(user.querySelector('.typed'), label, SPEED.CHAR_MS);
  setTimeout(()=>{ (String(value).substr(0,9)==="Contacter")?renderContact(String(value)):renderOptions(String(value)); }, 40);
}

/* API publique */
function format(item){ (item.substr(0,9)==="Contacter")?renderContact(item):renderOptions(item); }
function goback(){
  if(atContact&&backFromContact){
    if(trail[trail.length-1]&&String(trail[trail.length-1]).startsWith("contact:")) trail.pop();
    setHTML("#feed",""); format(backFromContact); return;
  }
  if(!parentKey) return; trail.pop(); setHTML("#feed",""); format(parentKey);
}
window.format=format; window.goback=goback;

/* Paletteur */
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('dg_theme', t);
  document.querySelectorAll('.theme-chip').forEach(ch=>ch.setAttribute('aria-current', ch.dataset.t===t ? 'true' : 'false'));
}
function initThemePicker(){
  const saved=localStorage.getItem('dg_theme'); if(saved){ applyTheme(saved); }
  document.querySelectorAll('.theme-chip').forEach(ch=>ch.addEventListener('click', ()=> applyTheme(ch.dataset.t)));
}

/* === Chargement robuste des JSON ==================================== */
async function fetchPapagoMulti(lang){
  const candidates=[
    papagoUrl + `papago-${lang}.json`,
    `trees/papago-${lang}.json`,
    `/trees/papago-${lang}.json`,
    `./papago-${lang}.json`
  ];
  for(const url of candidates){
    try{
      const res=await fetch(url + `?v=${Date.now()}`, {cache:"no-store"});
      if(res.ok){ const data=await res.json(); return {data, url}; }
    }catch(e){ /* try next */ }
  }
  return {data:null, url:null};
}

/* === Boot & diagnostics ============================================= */
function loadParams(){
  const p=new URLSearchParams(location.search);
  const qLang=p.get("lang"); const nt=p.get("notitle");
  if(qLang && (qLang==='fr'||qLang==='en')) lang=qLang;
  if(nt==="true"){ const h=document.querySelector('.header'); if(h) h.style.display="none"; }
}

function showErrorOnFeed(message, details){
  const skel=$("#boot-skel"); if(skel) skel.remove();
  const msg=addAssistantBubble();
  msg.querySelector('.text').innerHTML =
    `<div class="alert">‚ö† ${escapeHTML(message)}</div>` +
    (details? `<div class="debug">${escapeHTML(details)}</div>` : "");
}

async function boot(){
  loadParams(); initThemePicker();
  try{
    const {data, url}=await fetchPapagoMulti(lang);
    const skel=$("#boot-skel"); if(skel) skel.remove();

    if(data){
      papago=data;
      show($("#top-tools"));
      format("0");
      renderProgress();
      if(url && !url.includes('/trees/')){
        // Petit indice si le chemin actif n'est pas celui attendu
        showErrorOnFeed("Charg√© depuis un chemin alternatif.",
          `Chemin actif: ${url}. Si vous vouliez ./trees/, v√©rifiez la casse et le dossier.`);
      }
    }else{
      // Fallback ‚Äì UI fonctionne, mais on explique pourquoi
      papago=FALLBACK_TREE;
      show($("#top-tools"));
      format("0");
      renderProgress();
      showErrorOnFeed("Impossible de charger vos donn√©es (papago‚Äë*.json). Utilisation d‚Äôun jeu de donn√©es local de test.",
        "Chemins essay√©s: ./trees/, trees/, /trees/, ./ (avec cache‚Äëbuster). V√©rifiez l‚Äôemplacement et la casse des fichiers (ex: papago-fr.json).");
    }
  }catch(e){
    showErrorOnFeed(translate[lang]["error"], String(e&&e.message||e));
  }
}

/* Affichage d'erreurs runtime dans le flux (utile si ¬´ plus rien ne marche ¬ª) */
window.addEventListener('error', (ev)=> showErrorOnFeed("Erreur JavaScript", ev.message));
window.addEventListener('unhandledrejection', (ev)=> showErrorOnFeed("Promesse rejet√©e", String(ev.reason)));

document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
