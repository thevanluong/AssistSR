<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Doggygo · Neon Aurora</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

<style>
/* ==========================================================
   NEON AURORA — couleurs folles + verre sombre (mobile-first)
   - 1 colonne (mobile & desktop)
   - Multi‑ligne propre sur smartphone (aucune césure)
   - Apparition en cascade des cartes
   ========================================================== */
:root{
  /* Fond & texte */
  --bg: #080d1e;             /* marine très sombre */
  --ink: #eaf2ff;            /* texte principal */
  --muted: #a3b2d1;          /* texte secondaire */
  --line: rgba(255,255,255,.14);

  /* Accents néon */
  --a1: #ff4d9d;  /* rose */
  --a2: #7b5cff;  /* violet */
  --a3: #22f0b5;  /* menthe */
  --a4: #ffd166;  /* ambre */
  --a5: #40d4ff;  /* cyan */

  /* Verre + rayons */
  --panel: rgba(14,18,36,.72);
  --r: 14px; --r-lg: 18px;
  --shadow-1: 0 12px 28px rgba(2,6,20,.45);
  --shadow-2: 0 28px 80px rgba(2,6,20,.55);

  --fs-14: clamp(13.5px, 1vw, 14px);
  --fs-16: clamp(14px, 1.05vw, 16px);
  --fs-18: clamp(16px, 1.25vw, 18px);
  --fs-20: clamp(17px, 1.45vw, 20px);
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; color:var(--ink);
  font:400 var(--fs-16)/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Inter,Roboto,Arial,sans-serif;
  -webkit-font-smoothing: antialiased;
  background:
    radial-gradient(70vw 60vh at -10% -10%, rgba(123,92,255,.28), transparent 60%),
    radial-gradient(60vw 50vh at 110% 10%, rgba(64,212,255,.22), transparent 60%),
    radial-gradient(70vw 60vh at 20% 100%, rgba(255,77,157,.18), transparent 60%),
    linear-gradient(180deg, #0a1030 0%, #061127 40%, #050a1e 100%),
    var(--bg);
  padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
}

.container{
  max-width: 920px;           /* 1 colonne confort, style ChatGPT */
  margin: 0 auto;
  padding: clamp(12px, 3vw, 24px);
}

/* ===== Header ===== */
.header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.brand{ display:flex; align-items:center; gap:12px; }
.logo{ width:44px; height:44px; border-radius:12px; object-fit:cover; box-shadow:var(--shadow-1); }
.title{ margin:0; font-weight:800; font-size:var(--fs-20); letter-spacing:.2px; }
.sub{ margin:2px 0 0; color:var(--muted); font-size:var(--fs-14); }

.tools{ display:flex; gap:.55rem; }
.tools a{
  text-decoration:none; color:var(--ink);
  border:1px solid var(--line);
  padding:.5rem .9rem; border-radius:999px; font-weight:700; font-size:var(--fs-14);
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  backdrop-filter: blur(6px) saturate(140%);
}
.tools a:focus{ outline:none; box-shadow:0 0 0 .28rem rgba(123,92,255,.28); }

/* ===== Chat panel (verre + bordure arc‑en‑ciel) ===== */
.chat{
  margin-top:12px; border-radius:var(--r-lg);
  background:
    linear-gradient(var(--panel),var(--panel)) padding-box,
    linear-gradient(120deg, var(--a1), var(--a2), var(--a3), var(--a4), var(--a5)) border-box;
  border:1px solid transparent; box-shadow:var(--shadow-2); overflow:clip;
  backdrop-filter: blur(8px) saturate(140%);
}

.bar{
  display:flex; gap:.4rem; align-items:center; padding:10px 12px;
  border-bottom:1px solid var(--line);
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
}
.dot{
  width:24px; height:24px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center;
  font:700 var(--fs-14)/1 Inter,sans-serif; color:var(--ink);
  background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  border:1px solid var(--line);
}
.dot:last-child{
  color:var(--ink);
  border-image: linear-gradient(120deg, var(--a3), var(--a2)) 1; border-width:1px; border-style:solid;
}

.feed{ padding:12px; }

/* ===== Messages ===== */
.msg{ display:flex; align-items:flex-start; gap:10px; margin:12px 0; }
.avatar{
  width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:800;
  background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
  color:#9cecff; border:1px solid var(--line); font-size:15px; flex:0 0 auto;
}
.msg.user .avatar{ background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); color:#e1e7ff; }

/* Bulle verre sombre */
.bubble{
  width:100%; max-width:100%;
  border-radius:var(--r);
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid var(--line);
  box-shadow: 0 1px 0 rgba(0,0,0,.35);
  padding:12px 14px; line-height:1.6; font-size:var(--fs-16);
}
.bubble .title{ font-weight:800; margin-bottom:8px; font-size:var(--fs-18); }

/* ===== Options (pile verticale, 1 colonne) ===== */
.list{ margin-top:10px; }
.stack{ display:flex; flex-direction:column; gap:10px; }

/* Carte : verre + filet néon à gauche (couleur cyclée) */
.card{
  position:relative;
  display:grid;
  grid-template-columns: auto minmax(0,1fr) auto; /* icône | texte | chevron */
  align-items:center; column-gap:12px;
  border-radius:14px; padding:14px 16px; min-height:56px;
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid var(--line);
  text-decoration:none; color:var(--ink); font-weight:800; font-size:var(--fs-16);
  transform:translateY(6px); opacity:0; will-change:transform,opacity;
  overflow: hidden;
}
.card::before{
  content:""; position:absolute; left:-1px; top:-1px; bottom:-1px; width:5px; border-radius:12px;
  background: linear-gradient(180deg, var(--a1), var(--a2), var(--a3), var(--a4), var(--a5));
  filter: saturate(140%);
}
.card.reveal{ opacity:1; transform:translateY(0); transition:transform .16s ease, opacity .16s ease; }
.card:hover{ box-shadow:var(--shadow-1); transform:translateY(-1px); transition:transform .16s ease, box-shadow .16s ease; }
.card:active{ transform:translateY(0); }

/* Couleurs d’icône cyclées */
.ic{
  width:34px; height:34px; border-radius:10px; display:flex; align-items:center; justify-content:center;
  border:1px solid var(--line); flex:0 0 auto; color:var(--ink);
  background: radial-gradient(closest-side, rgba(127,255,212,.25), rgba(255,255,255,.08));
  filter: drop-shadow(0 6px 14px rgba(64,212,255,.25));
}
.card:nth-child(5n+1) .ic{ background: radial-gradient(closest-side, rgba(255,77,157,.30), rgba(255,255,255,.08)); color:#ffd7eb; }
.card:nth-child(5n+2) .ic{ background: radial-gradient(closest-side, rgba(123,92,255,.30), rgba(255,255,255,.08)); color:#e0d6ff; }
.card:nth-child(5n+3) .ic{ background: radial-gradient(closest-side, rgba(34,240,181,.30), rgba(255,255,255,.08)); color:#c7fff0; }
.card:nth-child(5n+4) .ic{ background: radial-gradient(closest-side, rgba(255,209,102,.34), rgba(255,255,255,.08)); color:#fff0c9; }
.card:nth-child(5n+5) .ic{ background: radial-gradient(closest-side, rgba(64,212,255,.30), rgba(255,255,255,.08)); color:#d9f6ff; }

/* Libellé multi‑ligne, sans césure (smartphone OK) */
.label, .label > span{
  min-width:0; display:block;
  white-space: normal;
  word-break: normal;
  overflow-wrap: break-word;   /* coupe seulement si un mot est trop long */
  -webkit-hyphens: manual; hyphens: manual; /* pas de césure auto */
  line-height:1.35;
}

.arr{ color: var(--muted); justify-self: end; }

/* ===== Actions ===== */
.actions{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:10px; }
.btn{
  text-decoration:none; color:var(--ink); border:1px solid var(--line);
  background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));
  padding:.5rem .9rem; border-radius:999px; font-weight:700; font-size:var(--fs-14);
}
.btn:focus{ outline:none; box-shadow:0 0 0 .28rem rgba(34,240,181,.28); }

/* ===== Contact ===== */
.contact{
  display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center;
  border:1px solid var(--line); border-radius:14px; padding:14px; margin-top:12px;
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  box-shadow:0 16px 36px rgba(0,0,0,.45);
}
.contact .ava{
  width:52px; height:52px; border-radius:12px; display:flex; align-items:center; justify-content:center;
  background: linear-gradient(180deg, var(--a2), var(--a3)); color:#081226; font-weight:900; border:1px solid rgba(255,255,255,.08); font-size:18px;
}
.contact .name{ font-weight:800; font-size:var(--fs-16); }
.contact .meta{ color:var(--muted); font-size:var(--fs-14); }
.contact .cta{
  text-decoration:none; color:#081226;
  background: linear-gradient(90deg, var(--a3), var(--a4));
  padding:.65rem 1rem; border-radius:999px; font-weight:900; font-size:var(--fs-14); border:0;
  box-shadow: 0 12px 26px rgba(34,240,181,.28);
}
@media (max-width:640px){ .contact{ grid-template-columns:1fr; } .contact .cta{ width:100%; text-align:center; } }

/* Note */
.note{ color:var(--muted); font-size:var(--fs-14); padding:10px 12px; border-top:1px solid var(--line); }

/* Accessibilité / motion */
@media (prefers-reduced-motion: reduce){
  .card{ transition:none !important; transform:none !important; opacity:1 !important; }
}
</style>
</head>

<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <img src="doggygo.png" class="logo" alt="">
        <div>
          <p class="title">Doggygo</p>
          <p class="sub">Assistant du Service de la recherche</p>
        </div>
      </div>
      <div class="tools" id="top-tools" style="display:none">
        <a id="back" href="javascript:goback();" style="display:none">← Retour</a>
        <a id="restart" href="javascript:location.reload()" style="display:none">⟲ Recommencer</a>
      </div>
    </header>

    <section class="chat">
      <div class="bar" id="progress" aria-live="polite"></div>
      <div class="feed" id="feed" aria-live="polite" aria-label="Flux de conversation"></div>
      <div class="note"><i class="fa-regular fa-circle-question"></i> Les liens de contact pointent vers l’annuaire UNIL.</div>
    </section>
  </div>

<script>
/* ==========================================================
   JS — dynamique rapide (1 colonne, stable iOS)
   - question/réponse : frappe par caractères
   - cartes : apparition en cascade (sans typing dans les cartes)
   ========================================================== */
const SPEED = { CHAR_MS: 7, STAGGER_MS: 28 };

var lang="fr", papagoUrl="./trees/";
var persons={
  "EAM":{ "name":"Eliane Abou Mansour","url":"https://annuaire.unil.ch/person/LgLLf7wep3kZBi" },
  "VL":{ "name":"Véronique Longchamp","url":"https://annuaire.unil.ch/person/u5rsd2fbRe7LFH" },
  "AEDC":{ "name":"Anne-Emmanuelle de Crousaz","url":"https://annuaire.unil.ch/person/R87FcLkKew3U7p" },
  "AB":{ "name":"Aurélie Brehmer","url":"https://annuaire.unil.ch/person/hk2dAGXkGb4U5w" },
  "CA":{ "name":"Claire Arnold","url":"https://annuaire.unil.ch/person/47c7LgpckuHb25" },
  "ZEM":{ "name":"Zohra El Masbahi","url":"https://annuaire.unil.ch/person/KGKZjmZikDrmpw" },
  "ACB":{ "name":"Anne-Christine Butty","url":"https://annuaire.unil.ch/person/LjB3d7wep3kZBi" },
  "MD":{ "name":"Maëlle Desard","url":"https://annuaire.unil.ch/person/hkifyGXkGb4U5w" },
  "PAD":{ "name":"Pablo Andrés Diaz","url":"https://annuaire.unil.ch/person/pfFzXB2bjLZnA4" },
  "TVL":{ "name":"Thé Van Luong","url":"https://annuaire.unil.ch/person/cmbpD4u7m9XUBj" },
  "MC":{ "name":"Micaela Crespo","url":"https://annuaire.unil.ch/person/cKu9p4u7m9XUBj" },
  "LC":{ "name":"Lucia Couto","url":"https://annuaire.unil.ch/person/p9L8fB2bjLZnA4" },
  "JR":{ "name":"Julian Randall","url":"https://annuaire.unil.ch/person/R4rszLkKew3U7p" }
};
var translate={
  "fr":{ "contact":"Contacter","text":"La personne ci‑dessous peut vous conseiller directement.","error":"Doggygo n'est pas accessible pour le moment." },
  "en":{ "contact":"Contact","text":"The person below can advise you directly.","error":"Doggygo is not available at the moment." }
};

var papago={}, currentKey="", parentKey="", atContact=false, backFromContact="", trail=[];

/* Helpers */
const $=s=>document.querySelector(s);
function setHTML(t,h){(typeof t==="string"?$(t):t).innerHTML=h;}
function show(el){el.style.display="";}
function hide(el){el.style.display="none";}
function escapeHTML(s){const d=document.createElement('div'); d.textContent=String(s||""); return d.innerHTML;}
function initials(n){if(!n) return "?"; const p=n.trim().split(/\s+/); return ((p[0]?.[0]||"")+(p[1]?.[0]||"")).toUpperCase()||"?";}
function scrollToBottom(){requestAnimationFrame(()=>window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}));}
function reduced(){return window.matchMedia&&window.matchMedia('(prefers-reduced-motion: reduce)').matches;}

/* Progress */
function renderProgress(){
  const el=$("#progress"); if(!el) return;
  if(!trail.length){el.innerHTML=""; return;}
  el.innerHTML=trail.map((_,i)=>`<span class="dot">${i+1}</span>`).join("");
}

/* Messages */
function addAssistantBubble(){
  const item=document.createElement('div');
  item.className="msg assistant";
  item.innerHTML=`<div class="avatar" aria-hidden="true">🐾</div>
    <div class="bubble"><div class="text"></div><div class="list"></div></div>`;
  $("#feed").appendChild(item); scrollToBottom(); return item;
}
function addUserBubble(){
  const item=document.createElement('div');
  item.className="msg user";
  item.innerHTML=`<div class="avatar" aria-hidden="true"></div><div class="bubble"><span class="typed"></span></div>`;
  $("#feed").appendChild(item); scrollToBottom(); return item;
}

/* Typing */
function typeChars(el,text,ms){
  if(reduced()){ el.textContent=text; return Promise.resolve(); }
  return new Promise(res=>{
    const span=document.createElement('span'); el.appendChild(span);
    let i=0; (function loop(){ if(i<text.length){ span.textContent+=text.charAt(i++); setTimeout(loop,ms); scrollToBottom(); } else res(); })();
  });
}

/* Options (pile + cascade) */
function createCard(opt){
  const a=document.createElement('a');
  a.href="javascript:void(0)";
  a.className="card";
  a.setAttribute('title', opt.option);
  a.setAttribute('aria-label', opt.option);
  a.innerHTML=`
    <div class="ic"><i class="fa-solid fa-bolt"></i></div>
    <div class="label"><span>${escapeHTML(opt.option)}</span></div>
    <div class="arr"><i class="fa-solid fa-chevron-right"></i></div>`;
  a.onclick=()=> choose(opt.value,opt.option,a);
  return a;
}
function revealCards(stack, options){
  options.forEach((opt,idx)=>{
    const card=createCard(opt); stack.appendChild(card);
    setTimeout(()=> card.classList.add('reveal'), idx*SPEED.STAGGER_MS);
  });
}

/* Étapes */
async function renderOptions(key){
  const node=papago[key]||{}; const label=String(node.label||"");
  parentKey=node.parent||""; currentKey=key; atContact=false;

  if(trail[trail.length-1]!==key) trail.push(key); renderProgress();

  const msg=addAssistantBubble();
  await typeChars(msg.querySelector('.text'), label, SPEED.CHAR_MS);

  const stack=document.createElement('div'); stack.className="stack";
  msg.querySelector('.list').appendChild(stack);
  revealCards(stack, node.options||[]);

  const actions=document.createElement('div'); actions.className="actions";
  if(node.parent){
    const back=document.createElement('a'); back.className="btn"; back.href="javascript:goback()"; back.textContent="← Retour"; actions.appendChild(back);
  }
  msg.querySelector('.bubble').appendChild(actions);

  show($("#top-tools")); node.parent?show($("#back")):hide($("#back")); hide($("#restart")); scrollToBottom();
}

async function renderContact(value){
  const code=(value.split(" ")[1]||"").trim(); const p=persons[code]||{};
  const name=p.name||code||"Contact"; const url=p.url||"#";

  backFromContact=currentKey; atContact=true;
  if(trail[trail.length-1]!=="contact:"+code) trail.push("contact:"+code); renderProgress();

  const msg=addAssistantBubble();
  await typeChars(msg.querySelector('.text'), translate[lang]["text"], SPEED.CHAR_MS);

  const card=document.createElement('div'); card.className="contact";
  card.innerHTML=`<div class="ava">${initials(name)}</div>
    <div><div class="name">${escapeHTML(name)}</div>
    <div class="meta"><i class="fa-regular fa-address-card"></i> UNIL · Service de la recherche</div></div>
    <div><a class="cta" target="_blank" rel="noopener" href="${url}"><i class="fa-solid fa-paper-plane"></i> ${escapeHTML(translate[lang]["contact"])}</a></div>`;
  msg.querySelector('.text').appendChild(card);

  const actions=document.createElement('div'); actions.className="actions";
  const back=document.createElement('a'); back.className="btn"; back.href="javascript:goback()"; back.textContent="← Retour"; actions.appendChild(back);
  const restart=document.createElement('a'); restart.className="btn"; restart.href="javascript:location.reload()"; restart.textContent="⟲ Recommencer"; actions.appendChild(restart);
  msg.querySelector('.bubble').appendChild(actions);

  show($("#top-tools")); show($("#back")); show($("#restart")); scrollToBottom();
}

/* Choix */
async function choose(value,label,card){
  const stack=card.parentElement; Array.from(stack.children).forEach(c=>{ c.style.pointerEvents="none"; c.style.opacity=.65; });

  const user=addUserBubble(); await typeChars(user.querySelector('.typed'), label, SPEED.CHAR_MS);

  setTimeout(()=>{ (String(value).substr(0,9)==="Contacter")?renderContact(String(value)):renderOptions(String(value)); }, 40);
}

/* API publique */
function format(item){ (item.substr(0,9)==="Contacter")?renderContact(item):renderOptions(item); }
function goback(){
  if(atContact&&backFromContact){
    if(trail[trail.length-1]&&String(trail[trail.length-1]).startsWith("contact:")) trail.pop();
    setHTML("#feed",""); format(backFromContact); return;
  }
  if(!parentKey) return; trail.pop(); setHTML("#feed",""); format(parentKey);
}
window.format=format; window.goback=goback;

/* Boot */
function loadParams(){ const p=new URLSearchParams(location.search); const qLang=p.get("lang"); const nt=p.get("notitle"); if(qLang&&translate[qLang]) lang=qLang; if(nt==="true"){ document.querySelector('.header').style.display="none"; } }
async function boot(){
  loadParams();
  try{
    const res=await fetch(papagoUrl+"papago-"+lang+".json",{cache:"no-store"}); papago=await res.json();
    show($("#top-tools")); format("0");
  }catch(e){
    console.error(e);
    const msg=addAssistantBubble(); msg.querySelector('.text').innerHTML=`<div role="alert" style="color:#ffb3b3;font-weight:700;margin:0">⚠ ${translate[lang]['error']}</div>`;
    show($("#top-tools")); hide($("#back")); show($("#restart"));
  }
}
document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
