<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Doggygo · Luxe Palettes</title>

<!-- Icônes & typo -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
/* ==========================================================
   DOGGYGO — Luxe Palettes (clair & sombre)
   - 1 colonne (mobile & desktop)
   - Thèmes sélectionnables (data-theme)
   - Accessibilité (contrastes, focus ring)
   - Motion friendly
   ========================================================== */

/* ================================
   THEME PALETTE PACK (drop-in)
   ================================ */

/* --- Default (clair) --- */
:root,
:root[data-theme="porcelain-dawn"],
body[data-theme="porcelain-dawn"]{
  --ink:   #0f172a;  /* texte principal */
  --muted: #5f6b7c;  /* texte secondaire */
  --line:  #e8eef6;  /* bordures */
  --panel: #ffffff;  /* surfaces (cartes, bulles) */
  --bg-1:  #f7fafc;  /* fond bas */
  --bg-2:  #f5f9ff;  /* fond haut */

  --accent-1: #2563eb; /* bleu signature */
  --accent-2: #06b6d4; /* cyan frais */
  --accent-3: #f59e0b; /* ambre discret */

  --halo-1: rgba(37,99,235,.12);
  --halo-2: rgba(6,182,212,.12);
}

/* --- Sapphire Champagne (dark luxe) --- */
:root[data-theme="sapphire-champagne"],
body[data-theme="sapphire-champagne"]{
  --ink:   #eaf2ff;
  --muted: #9fb2d0;
  --line:  rgba(255,255,255,.16);
  --panel: rgba(16,23,38,.72);
  --bg-1:  #070b16;
  --bg-2:  #0b1224;

  --accent-1: #3b82f6; /* bleu saphir */
  --accent-2: #38bdf8; /* cyan lumière */
  --accent-3: #f4c27a; /* champagne */

  --halo-1: rgba(59,130,246,.20);
  --halo-2: rgba(56,189,248,.16);
}

/* --- Verdant Fjord (dark green) --- */
:root[data-theme="verdant-fjord"],
body[data-theme="verdant-fjord"]{
  --ink:   #e8fff6;
  --muted: #9bc3b6;
  --line:  rgba(255,255,255,.14);
  --panel: rgba(12,24,21,.72);
  --bg-1:  #05110e;
  --bg-2:  #0a1915;

  --accent-1: #10b981; /* émeraude */
  --accent-2: #34d399; /* jade */
  --accent-3: #f59e0b; /* ambre */

  --halo-1: rgba(16,185,129,.20);
  --halo-2: rgba(52,211,153,.16);
}

/* --- Cerulean Mist (clair frais) --- */
:root[data-theme="cerulean-mist"],
body[data-theme="cerulean-mist"]{
  --ink:   #0b1b2a;
  --muted: #5f6b7c;
  --line:  #e6edf3;
  --panel: #ffffff;
  --bg-1:  #f5f9ff;
  --bg-2:  #eef6ff;

  --accent-1: #2563eb; /* bleu */
  --accent-2: #22d3ee; /* cyan */
  --accent-3: #93c5fd; /* bleu clair */

  --halo-1: rgba(37,99,235,.10);
  --halo-2: rgba(34,211,238,.10);
}

/* --- Royal Noir (graphite & or) --- */
:root[data-theme="royal-noir"],
body[data-theme="royal-noir"]{
  --ink:   #f1f4ff;
  --muted: #a3acc2;
  --line:  rgba(255,255,255,.18);
  --panel: rgba(17,19,28,.74);
  --bg-1:  #0a0c12;
  --bg-2:  #111421;

  --accent-1: #f59e0b; /* or/ambre */
  --accent-2: #fde68a; /* or pâle */
  --accent-3: #60a5fa; /* bleu royal */

  --halo-1: rgba(245,158,11,.20);
  --halo-2: rgba(96,165,250,.16);
}

/* --- Terracotta Sand (clair éditorial) --- */
:root[data-theme="terracotta-sand"],
body[data-theme="terracotta-sand"]{
  --ink:   #2b1e17;
  --muted: #816c5e;
  --line:  #efe3da;
  --panel: #ffffff;
  --bg-1:  #fdfaf7;
  --bg-2:  #faf3ee;

  --accent-1: #d97706; /* ambre rust */
  --accent-2: #f26d50; /* corail */
  --accent-3: #16a34a; /* vert feuille */

  --halo-1: rgba(242,109,80,.10);
  --halo-2: rgba(217,119,6,.10);
}

/* --- Côte du Léman (clair azur & teal) --- */
:root[data-theme="cote-leman"],
body[data-theme="cote-leman"]{
  --ink:   #0a172a;
  --muted: #5f6b7c;
  --line:  #e8eef6;
  --panel: #ffffff;
  --bg-1:  #f6fbff;
  --bg-2:  #eef9ff;

  --accent-1: #0ea5e9; /* azur */
  --accent-2: #14b8a6; /* teal */
  --accent-3: #f59e0b; /* ambre */

  --halo-1: rgba(14,165,233,.10);
  --halo-2: rgba(20,184,166,.10);
}

/* --- Amethyst Opal (dark violet) --- */
:root[data-theme="amethyst-opal"],
body[data-theme="amethyst-opal"]{
  --ink:   #efeaff;
  --muted: #b4add7;
  --line:  rgba(255,255,255,.16);
  --panel: rgba(27,20,47,.72);
  --bg-1:  #0a0913;
  --bg-2:  #14142b;

  --accent-1: #7c3aed; /* améthyste */
  --accent-2: #a78bfa; /* lavande luz */
  --accent-3: #22d3ee; /* opale cyan */

  --halo-1: rgba(124,58,237,.20);
  --halo-2: rgba(167,139,250,.16);
}

/* ================================
   Base + composants (thémables)
   ================================ */

*{ box-sizing: border-box; }
html,body{ height:100%; }
body{
  margin:0; color:var(--ink);
  font: 400 clamp(14px, 1.05vw, 16px)/1.7 Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Roboto, Arial, sans-serif;
  -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;

  /* Fond : halos subtils + dégradé vertical */
  background:
    radial-gradient(50vw 60vh at 100% 0%, var(--halo-2), transparent 60%),
    radial-gradient(60vw 60vh at 0% 100%, var(--halo-1), transparent 60%),
    linear-gradient(180deg, var(--bg-1), var(--bg-2));
  padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
}

/* ===== Shell (une colonne) ===== */
.container{
  max-width: 960px;
  margin: 0 auto;
  padding: clamp(12px, 3vw, 28px);
}

/* ===== Header ===== */
.header{ display:flex; align-items:center; justify-content:space-between; gap:14px; }
.brand{ display:flex; align-items:center; gap:14px; }
.logo{
  width:46px; height:46px; border-radius:14px; object-fit:cover;
  border: 1px solid var(--line);
  box-shadow: 0 10px 26px rgba(2,8,23,.18), inset 0 1px 0 rgba(255,255,255,.04);
  filter: saturate(1.05) contrast(1.03);
}
.title{ margin:0; font-weight:800; font-size:clamp(18px, 1.6vw, 22px); letter-spacing:.2px; }
.header .title{
  background: linear-gradient(90deg, var(--accent-2), var(--accent-1));
  -webkit-background-clip:text; background-clip:text; color:transparent;
}
.sub{ margin:2px 0 0; color:var(--muted); font-size:clamp(13.5px, 1vw, 14px); opacity:.95; }

.tools{ display:flex; gap:.55rem; align-items:center; }
.tools a,
.tools .theme-picker{
  text-decoration:none; color:var(--ink); font-weight:700; font-size:clamp(13.5px, 1vw, 14px);
  padding:.55rem .9rem; border-radius:999px;
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
  border: 1px solid var(--line);
  box-shadow: 0 10px 24px rgba(2,8,23,.08), inset 0 1px 0 rgba(255,255,255,.06);
  backdrop-filter: blur(10px) saturate(140%);
  -webkit-backdrop-filter: blur(10px) saturate(140%);
}
.tools a:hover, .tools .theme-picker:hover{ transform: translateY(-1px); box-shadow: 0 16px 34px rgba(2,8,23,.12); }
.tools a:active, .tools .theme-picker:active{ transform: translateY(0); }
.tools a:focus-visible, .tools .theme-picker:focus-within{ outline:none; box-shadow: 0 0 0 .24rem rgba(37,99,235,.28); }

.theme-picker{ display:flex; gap:.45rem; align-items:center; }
.theme-picker i{ opacity:.9; }
.theme-picker select{
  appearance: none; -webkit-appearance: none; -moz-appearance: none;
  border: none; background: transparent; color: var(--ink); font-weight: 800;
  padding-right: 1.2rem; cursor: pointer;
}
.theme-picker .chev{
  margin-left:-1rem; pointer-events:none; opacity:.7;
}

/* ===== Chat panel — verre + bordure dégradée ===== */
.chat{
  margin-top: 16px; border-radius: 22px;
  background:
    linear-gradient(180deg, var(--panel), var(--panel)) padding-box,
    linear-gradient(120deg, color-mix(in srgb, var(--accent-1) 70%, transparent),
                           color-mix(in srgb, var(--accent-2) 70%, transparent),
                           color-mix(in srgb, var(--accent-3) 50%, transparent)) border-box;
  border: 1px solid transparent;
  box-shadow: 0 30px 80px rgba(2,8,23,.18);
  overflow: clip;
  backdrop-filter: blur(14px) saturate(150%);
  -webkit-backdrop-filter: blur(14px) saturate(150%);
}
@supports not (color-mix(in srgb, white 50%, black)){
  .chat{ /* Fallback sans color-mix */
    background:
      linear-gradient(180deg, var(--panel), var(--panel)) padding-box,
      linear-gradient(120deg, rgba(37,99,235,.65), rgba(6,182,212,.6), rgba(245,158,11,.42)) border-box;
  }
}
.chat::after{ /* ligne décorative intérieure */
  content:""; display:block; height: 1px;
  background: linear-gradient(90deg, rgba(6,182,212,.30), rgba(255,255,255,.40), rgba(37,99,235,.30));
  opacity:.65;
}

/* Barre de progression */
.bar{
  display:flex; gap:.45rem; align-items:center; padding:10px 12px;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  border-bottom: 1px solid var(--line);
  backdrop-filter: blur(8px) saturate(140%); -webkit-backdrop-filter: blur(8px) saturate(140%);
}
.dot{
  width:24px; height:24px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center;
  font:800 clamp(13.5px, 1vw, 14px)/1 Inter, sans-serif; color: color-mix(in srgb, var(--ink) 80%, white 20%);
  background:
    radial-gradient(100% 100% at 50% 0%, rgba(255,255,255,.12), rgba(255,255,255,.06)),
    linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
  border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 6px 16px rgba(0,0,0,.12);
}
.dot:last-child{
  color:#0b172a;
  background: linear-gradient(90deg, var(--accent-2), var(--accent-1));
  border:1px solid rgba(255,255,255,.25);
}

/* Flux */
.feed{ padding: 12px; }

/* ===== Messages ===== */
.msg{ display:flex; align-items:flex-start; gap:12px; margin: 14px 0; }
.avatar{
  width:30px; height:30px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800;
  background:
    conic-gradient(from 120deg, color-mix(in srgb, var(--accent-1) 34%, transparent),
                             color-mix(in srgb, var(--accent-2) 34%, transparent),
                             color-mix(in srgb, var(--accent-3) 24%, transparent),
                             color-mix(in srgb, var(--accent-1) 34%, transparent));
  color:#0e1324; border:1px solid color-mix(in srgb, var(--line) 70%, transparent); font-size:16px; flex:0 0 auto;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.12), 0 10px 24px rgba(2,8,23,.12);
}
.msg.user .avatar{
  background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
  color: color-mix(in srgb, var(--ink) 75%, white 25%);
}

/* Bulle (surface) */
.bubble{
  width:100%; max-width:100%;
  border-radius: 16px;
  background: linear-gradient(180deg, var(--panel), var(--panel));
  border: 1px solid var(--line);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 1px 0 rgba(12,27,42,.03), 0 10px 24px rgba(2,8,23,.08);
  padding: 14px 16px; line-height: 1.65; font-size: clamp(14px, 1.05vw, 16px);
}
.bubble .title{ font-weight:800; margin-bottom:8px; font-size: clamp(16px, 1.25vw, 18px); }

/* ===== Options (pile verticale) ===== */
.list{ margin-top:10px; }
.stack{ display:flex; flex-direction:column; gap:10px; }

.card{
  position: relative;
  display: grid;
  grid-template-columns: auto minmax(0,1fr) auto; /* icône | texte | chevron */
  align-items: center; column-gap: 12px;
  border-radius: 18px; padding: 14px 16px; min-height: 60px;
  background:
    linear-gradient(180deg, var(--panel), var(--panel)) padding-box,
    linear-gradient(120deg, color-mix(in srgb, var(--accent-1) 70%, transparent),
                           color-mix(in srgb, var(--accent-2) 70%, transparent),
                           color-mix(in srgb, var(--accent-3) 50%, transparent)) border-box;
  border: 1px solid transparent;
  box-shadow: 0 1px 0 rgba(255,255,255,.03), 0 10px 22px rgba(2,8,23,.10);
  text-decoration: none; color: inherit; font-weight: 800; font-size: clamp(14px, 1.05vw, 16px);
  transform: translateY(6px) scale(.995); opacity: 0; will-change: transform, opacity, box-shadow;
  overflow: hidden;
  backdrop-filter: blur(10px) saturate(150%); -webkit-backdrop-filter: blur(10px) saturate(150%);
}
@supports not (color-mix(in srgb, white 50%, black)){
  .card{ background:
    linear-gradient(180deg, var(--panel), var(--panel)) padding-box,
    linear-gradient(120deg, rgba(37,99,235,.70), rgba(6,182,212,.70), rgba(245,158,11,.50)) border-box;
  }
}
.card::after{ /* lueur oblique au survol */
  content:""; position:absolute; inset:-1px; background:
    linear-gradient(120deg, rgba(255,255,255,.12), transparent 35%, transparent 65%, rgba(255,255,255,.10));
  opacity:0; transition: opacity .25s ease;
}
.card.reveal{ opacity:1; transform: translateY(0) scale(1); transition: transform .18s ease, opacity .18s ease, box-shadow .18s ease; }
.card:hover{
  transform: translateY(-1px) scale(1.005);
  box-shadow: 0 16px 36px rgba(2,8,23,.16);
}
.card:hover::after{ opacity:.8; }
.card:active{ transform: translateY(0) scale(.997); }

.ic{
  width:38px; height:38px; border-radius: 12px; display:flex; align-items:center; justify-content:center;
  background:
    conic-gradient(from 180deg at 50% 50%, color-mix(in srgb, var(--accent-1) 30%, transparent),
                                   color-mix(in srgb, var(--accent-2) 30%, transparent),
                                   color-mix(in srgb, var(--accent-3) 20%, transparent),
                                   color-mix(in srgb, var(--accent-1) 30%, transparent));
  border: 1px solid color-mix(in srgb, var(--line) 70%, transparent); color: color-mix(in srgb, var(--ink) 85%, white 15%);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.18), 0 6px 16px rgba(2,8,23,.10);
}

.label, .label > span{
  min-width:0; display:block;
  white-space: normal; word-break: normal; overflow-wrap: break-word;
  -webkit-hyphens: manual; hyphens: manual; line-height: 1.35;
}
.arr{ color: var(--muted); justify-self: end; }

/* ===== Actions ===== */
.actions{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top: 10px; }
.btn{
  text-decoration:none; color:var(--ink); font-weight:700; font-size:clamp(13.5px, 1vw, 14px);
  padding:.55rem .95rem; border-radius:999px;
  background: linear-gradient(90deg, color-mix(in srgb, var(--accent-1) 20%, transparent),
                                   color-mix(in srgb, var(--accent-2) 20%, transparent));
  border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
  box-shadow: 0 4px 16px rgba(2,8,23,.08), inset 0 1px 0 rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
}
.btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 28px rgba(2,8,23,.14); }
.btn:active{ transform: translateY(0); }
.btn:focus-visible{ outline:none; box-shadow: 0 0 0 .28rem color-mix(in srgb, var(--accent-1) 35%, transparent); }

/* ===== Contact ===== */
.contact{
  display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center;
  border:1px solid var(--line); border-radius:18px; padding:14px; margin-top:12px;
  background: linear-gradient(180deg, var(--panel), var(--panel));
  box-shadow: 0 16px 36px rgba(2,8,23,.12), inset 0 1px 0 rgba(255,255,255,.08);
  backdrop-filter: blur(12px) saturate(150%);
}
.contact .ava{
  width:58px; height:58px; border-radius:14px; display:flex; align-items:center; justify-content:center;
  background: linear-gradient(135deg, var(--accent-2), var(--accent-1));
  color:#0b1327; font-weight:900; border:1px solid color-mix(in srgb, var(--line) 70%, transparent); font-size:18px;
  box-shadow: 0 12px 26px rgba(2,8,23,.16), inset 0 1px 0 rgba(255,255,255,.22);
}
.contact .name{ font-weight:800; font-size:clamp(14px, 1.05vw, 16px); }
.contact .meta{ color:var(--muted); font-size:clamp(13.5px, 1vw, 14px); }
.contact .cta{
  text-decoration:none; color:#061224;
  background: linear-gradient(90deg, var(--accent-2), var(--accent-1));
  padding:.65rem 1rem; border-radius:999px; font-weight:900; font-size:clamp(13.5px, 1vw, 14px); border:0;
  box-shadow: 0 12px 24px color-mix(in srgb, var(--accent-2) 24%, transparent), 0 12px 24px color-mix(in srgb, var(--accent-1) 24%, transparent);
}
.contact .cta:hover{ transform: translateY(-1px); }
.contact .cta:focus-visible{ outline:none; box-shadow: 0 0 0 .28rem color-mix(in srgb, var(--accent-1) 38%, transparent); }

@media (max-width:640px){
  .contact{ grid-template-columns:1fr; }
  .contact .cta{ width:100%; text-align:center; }
}

/* Note */
.note{
  color:var(--muted); font-size:clamp(13.5px, 1vw, 14px); padding: 10px 12px; border-top: 1px solid var(--line);
  background: linear-gradient(180deg, var(--panel), var(--panel));
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
}

/* Motion reduce */
@media (prefers-reduced-motion: reduce){
  .card{ transition:none !important; transform:none !important; opacity:1 !important; }
  .card:hover,.btn:hover{ transform:none !important; }
}

/* Fallback sans backdrop (navigateurs anciens) */
@supports not ((-webkit-backdrop-filter: none) or (backdrop-filter: none)){
  .chat,.bubble,.card,.tools a,.theme-picker,.contact,.note{ background-color: var(--panel); }
}
</style>
</head>

<!-- Définis le thème par défaut ici -->
<body data-theme="porcelain-dawn">
  <div class="container">
    <header class="header">
      <div class="brand">
        <img src="doggygo.png" class="logo" alt="">
        <div>
          <p class="title">Doggygo</p>
          <p class="sub">Assistant du Service de la recherche</p>
        </div>
      </div>

      <!-- Outils (navigation + sélecteur de thème) -->
      <div class="tools" id="top-tools" style="display:none">
        <div class="theme-picker" id="theme-picker" title="Choisir un thème">
          <i class="fa-solid fa-palette" aria-hidden="true"></i>
          <label for="theme-select" class="sr-only" style="position:absolute;left:-9999px;">Thème</label>
          <select id="theme-select" aria-label="Thème">
            <option value="porcelain-dawn">Porcelain Dawn (clair)</option>
            <option value="cerulean-mist">Cerulean Mist (clair)</option>
            <option value="terracotta-sand">Terracotta Sand (clair)</option>
            <option value="cote-leman">Côte du Léman (clair)</option>
            <option value="sapphire-champagne">Sapphire Champagne (sombre)</option>
            <option value="verdant-fjord">Verdant Fjord (sombre)</option>
            <option value="royal-noir">Royal Noir (sombre)</option>
            <option value="amethyst-opal">Amethyst Opal (sombre)</option>
          </select>
          <span class="chev"><i class="fa-solid fa-chevron-down" aria-hidden="true"></i></span>
        </div>
        <a id="back" href="javascript:goback();" style="display:none">← Retour</a>
        <a id="restart" href="javascript:location.reload()" style="display:none">⟲ Recommencer</a>
      </div>
    </header>

    <section class="chat">
      <div class="bar" id="progress" aria-live="polite"></div>
      <div class="feed" id="feed" aria-live="polite" aria-label="Flux de conversation"></div>
      <div class="note"><i class="fa-regular fa-circle-question"></i> Les liens de contact pointent vers l’annuaire UNIL.</div>
    </section>
  </div>

<script>
/* ==========================================================
   JS — logique existante + gestion du thème
   ========================================================== */
const SPEED = { CHAR_MS: 7, STAGGER_MS: 26 };

var lang="fr", papagoUrl="./trees/";
var persons={
  "EAM":{ "name":"Eliane Abou Mansour","url":"https://annuaire.unil.ch/person/LgLLf7wep3kZBi" },
  "VL":{ "name":"Véronique Longchamp","url":"https://annuaire.unil.ch/person/u5rsd2fbRe7LFH" },
  "AEDC":{ "name":"Anne-Emmanuelle de Crousaz","url":"https://annuaire.unil.ch/person/R87FcLkKew3U7p" },
  "AB":{ "name":"Aurélie Brehmer","url":"https://annuaire.unil.ch/person/hk2dAGXkGb4U5w" },
  "CA":{ "name":"Claire Arnold","url":"https://annuaire.unil.ch/person/47c7LgpckuHb25" },
  "ZEM":{ "name":"Zohra El Masbahi","url":"https://annuaire.unil.ch/person/KGKZjmZikDrmpw" },
  "ACB":{ "name":"Anne-Christine Butty","url":"https://annuaire.unil.ch/person/LjB3d7wep3kZBi" },
  "MD":{ "name":"Maëlle Desard","url":"https://annuaire.unil.ch/person/hkifyGXkGb4U5w" },
  "PAD":{ "name":"Pablo Andrés Diaz","url":"https://annuaire.unil.ch/person/pfFzXB2bjLZnA4" },
  "TVL":{ "name":"Thé Van Luong","url":"https://annuaire.unil.ch/person/cmbpD4u7m9XUBj" },
  "MC":{ "name":"Micaela Crespo","url":"https://annuaire.unil.ch/person/cKu9p4u7m9XUBj" },
  "LC":{ "name":"Lucia Couto","url":"https://annuaire.unil.ch/person/p9L8fB2bjLZnA4" },
  "JR":{ "name":"Julian Randall","url":"https://annuaire.unil.ch/person/R4rszLkKew3U7p" }
};
var translate={
  "fr":{ "contact":"Contacter","text":"La personne ci‑dessous peut vous conseiller directement.","error":"Doggygo n'est pas accessible pour le moment." },
  "en":{ "contact":"Contact","text":"The person below can advise you directly.","error":"Doggygo is not available at the moment." }
};

var papago={}, currentKey="", parentKey="", atContact=false, backFromContact="", trail=[];

/* ===== Thème : helpers ===== */
const THEMES = ["porcelain-dawn","cerulean-mist","terracotta-sand","cote-leman","sapphire-champagne","verdant-fjord","royal-noir","amethyst-opal"];
function applyTheme(name){
  if(!name || !THEMES.includes(name)){ return; }
  document.body.dataset.theme = name;
  try{ localStorage.setItem("doggygo_theme", name); }catch(e){}
  const sel = document.getElementById('theme-select');
  if(sel && sel.value !== name){ sel.value = name; }
}
function initThemeFromParamOrStorage(){
  const p = new URLSearchParams(location.search);
  const th = p.get("theme");
  if(th && THEMES.includes(th)){ applyTheme(th); return; }
  try{
    const saved = localStorage.getItem("doggygo_theme");
    if(saved && THEMES.includes(saved)){ applyTheme(saved); return; }
  }catch(e){}
  // sinon on garde l'attribut data-theme défini dans <body>
}
function setupThemePicker(){
  const sel = document.getElementById('theme-select');
  if(!sel) return;
  // Align value avec le thème courant
  const current = document.body.dataset.theme;
  if(current && THEMES.includes(current)){ sel.value = current; }
  sel.addEventListener('change', e => applyTheme(e.target.value));
  // Raccourci clavier : T pour cycler
  window.addEventListener('keydown', e=>{
    if(e.key.toLowerCase() === 't' && !e.metaKey && !e.ctrlKey && !e.altKey){
      const i = THEMES.indexOf(document.body.dataset.theme || "porcelain-dawn");
      const next = THEMES[(i+1)%THEMES.length]; applyTheme(next);
    }
  });
}

/* ===== Helpers existants ===== */
const $=s=>document.querySelector(s);
function setHTML(t,h){(typeof t==="string"?$(t):t).innerHTML=h;}
function show(el){el.style.display="";}
function hide(el){el.style.display="none";}
function escapeHTML(s){const d=document.createElement('div'); d.textContent=String(s||""); return d.innerHTML;}
function initials(n){if(!n) return "?"; const p=n.trim().split(/\s+/); return ((p[0]?.[0]||"")+(p[1]?.[0]||"")).toUpperCase()||"?";}
function scrollToBottom(){requestAnimationFrame(()=>window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}));}
function reduced(){return window.matchMedia&&window.matchMedia('(prefers-reduced-motion: reduce)').matches;}

/* Progress */
function renderProgress(){
  const el=$("#progress"); if(!el) return;
  if(!trail.length){el.innerHTML=""; return;}
  el.innerHTML=trail.map((_,i)=>`<span class="dot">${i+1}</span>`).join("");
}

/* Messages */
function addAssistantBubble(){
  const item=document.createElement('div');
  item.className="msg assistant";
  item.innerHTML=`<div class="avatar" aria-hidden="true">🐾</div>
    <div class="bubble"><div class="text"></div><div class="list"></div></div>`;
  $("#feed").appendChild(item); scrollToBottom(); return item;
}
function addUserBubble(){
  const item=document.createElement('div');
  item.className="msg user";
  item.innerHTML=`<div class="avatar" aria-hidden="true"></div><div class="bubble"><span class="typed"></span></div>`;
  $("#feed").appendChild(item); scrollToBottom(); return item;
}

/* Typing */
function typeChars(el,text,ms){
  if(reduced()){ el.textContent=text; return Promise.resolve(); }
  return new Promise(res=>{
    const span=document.createElement('span'); el.appendChild(span);
    let i=0; (function loop(){ if(i<text.length){ span.textContent+=text.charAt(i++); setTimeout(loop,ms); scrollToBottom(); } else res(); })();
  });
}

/* Options (pile + cascade) */
function createCard(opt){
  const a=document.createElement('a');
  a.href="javascript:void(0)";
  a.className="card";
  a.setAttribute('title', opt.option);
  a.setAttribute('aria-label', opt.option);
  a.innerHTML=`
    <div class="ic"><i class="fa-solid fa-bolt"></i></div>
    <div class="label"><span>${escapeHTML(opt.option)}</span></div>
    <div class="arr"><i class="fa-solid fa-chevron-right"></i></div>`;
  a.onclick=()=> choose(opt.value,opt.option,a);
  return a;
}
function revealCards(stack, options){
  options.forEach((opt,idx)=>{
    const card=createCard(opt); stack.appendChild(card);
    setTimeout(()=> card.classList.add('reveal'), idx*SPEED.STAGGER_MS);
  });
}

/* Étapes */
async function renderOptions(key){
  const node=papago[key]||{}; const label=String(node.label||"");
  parentKey=node.parent||""; currentKey=key; atContact=false;

  if(trail[trail.length-1]!==key) trail.push(key); renderProgress();

  const msg=addAssistantBubble();
  await typeChars(msg.querySelector('.text'), label, SPEED.CHAR_MS);

  const stack=document.createElement('div'); stack.className="stack";
  msg.querySelector('.list').appendChild(stack);
  revealCards(stack, node.options||[]);

  const actions=document.createElement('div'); actions.className="actions";
  if(node.parent){
    const back=document.createElement('a'); back.className="btn"; back.href="javascript:goback()"; back.textContent="← Retour"; actions.appendChild(back);
  }
  msg.querySelector('.bubble').appendChild(actions);

  show($("#top-tools")); node.parent?show($("#back")):hide($("#back")); hide($("#restart")); scrollToBottom();
}

async function renderContact(value){
  const code=(value.split(" ")[1]||"").trim(); const p=persons[code]||{};
  const name=p.name||code||"Contact"; const url=p.url||"#";

  backFromContact=currentKey; atContact=true;
  if(trail[trail.length-1]!=="contact:"+code) trail.push("contact:"+code); renderProgress();

  const msg=addAssistantBubble();
  await typeChars(msg.querySelector('.text'), translate[lang]["text"], SPEED.CHAR_MS);

  const card=document.createElement('div'); card.className="contact";
  card.innerHTML=`<div class="ava">${initials(name)}</div>
    <div><div class="name">${escapeHTML(name)}</div>
    <div class="meta"><i class="fa-regular fa-address-card"></i> UNIL · Service de la recherche</div></div>
    <div><a class="cta" target="_blank" rel="noopener" href="${url}"><i class="fa-solid fa-paper-plane"></i> ${escapeHTML(translate[lang]["contact"])}</a></div>`;
  msg.querySelector('.text').appendChild(card);

  const actions=document.createElement('div'); actions.className="actions";
  const back=document.createElement('a'); back.className="btn"; back.href="javascript:goback()"; back.textContent="← Retour"; actions.appendChild(back);
  const restart=document.createElement('a'); restart.className="btn"; restart.href="javascript:location.reload()"; restart.textContent="⟲ Recommencer"; actions.appendChild(restart);
  msg.querySelector('.bubble').appendChild(actions);

  show($("#top-tools")); show($("#back")); show($("#restart")); scrollToBottom();
}

/* Choix */
async function choose(value,label,card){
  const stack=card.parentElement; Array.from(stack.children).forEach(c=>{ c.style.pointerEvents="none"; c.style.opacity=.65; });

  const user=addUserBubble(); await typeChars(user.querySelector('.typed'), label, SPEED.CHAR_MS);

  setTimeout(()=>{ (String(value).substr(0,9)==="Contacter")?renderContact(String(value)):renderOptions(String(value)); }, 40);
}

/* API publique */
function format(item){ (item.substr(0,9)==="Contacter")?renderContact(item):renderOptions(item); }
function goback(){
  if(atContact&&backFromContact){
    if(trail[trail.length-1]&&String(trail[trail.length-1]).startsWith("contact:")) trail.pop();
    setHTML("#feed",""); format(backFromContact); return;
  }
  if(!parentKey) return; trail.pop(); setHTML("#feed",""); format(parentKey);
}
window.format=format; window.goback=goback;

/* Boot */
function loadParams(){
  const p=new URLSearchParams(location.search);
  const qLang=p.get("lang");
  const nt=p.get("notitle");
  if(qLang&&translate[qLang]) lang=qLang;
  if(nt==="true"){ document.querySelector('.header').style.display="none"; }
}
async function boot(){
  loadParams();
  initThemeFromParamOrStorage();
  setupThemePicker();
  try{
    const res=await fetch(papagoUrl+"papago-"+lang+".json",{cache:"no-store"}); papago=await res.json();
    show($("#top-tools")); format("0");
  }catch(e){
    console.error(e);
    const msg=addAssistantBubble(); msg.querySelector('.text').innerHTML=`<div role="alert" style="color:#b42318;font-weight:700;margin:0">⚠ ${translate[lang]['error']}</div>`;
    show($("#top-tools")); hide($("#back")); show($("#restart"));
  }
}
document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
