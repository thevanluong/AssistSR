<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Doggygo · AssistSR2</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

<style>
/* =========================================================
   QUARTZ GRID — nouveau design, mobile-first, très fluide
   (aucune dépendance CSS)
   ========================================================= */
:root{
  color-scheme: light dark;

  /* Palette claire / sombre */
  --bg: #f6f7fb;
  --panel: #ffffff;
  --ink: #0f172a;
  --muted: #64748b;
  --line: #e5e7eb;
  --chip: #f3f4f7;
  --accent: #0ea5a4;

  --bg-dark: #0e1117; --panel-dark:#0f131a; --ink-dark:#e6e8ee;
  --muted-dark:#9aa3af; --line-dark:#232a35; --chip-dark:#151b22;

  /* Rayons, ombres, tailles fluides */
  --r: 14px; --r-lg: 18px;
  --shadow-1: 0 8px 24px rgba(2,8,23,.08);
  --shadow-2: 0 14px 36px rgba(2,8,23,.10);

  --fs-12: clamp(12px, .9vw, 13px);
  --fs-14: clamp(13px, 1vw, 14px);
  --fs-16: clamp(14px, 1.1vw, 16px);
  --fs-18: clamp(16px, 1.3vw, 18px);
  --fs-20: clamp(17px, 1.6vw, 20px);
}

@media (prefers-color-scheme: dark){
  :root{
    --bg: var(--bg-dark); --panel: var(--panel-dark);
    --ink: var(--ink-dark); --muted: var(--muted-dark);
    --line: var(--line-dark); --chip: var(--chip-dark);
  }
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; color:var(--ink);
  font: 400 var(--fs-16)/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Inter,Roboto,Arial,sans-serif;
  background:
    radial-gradient(85vw 40vh at 70% -20%, rgba(14,165,233,.08), transparent 60%),
    radial-gradient(80vw 42vh at -10% 0%, rgba(14,165,233,.06), transparent 60%),
    var(--bg);
  padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
}

/* ===== Shell ===== */
.container{
  max-width: 1180px;    /* -> occupe bien l’espace sur desktop */
  margin: 0 auto;
  padding: clamp(12px, 3vw, 28px);
}

/* ===== Header ===== */
.header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.brand{ display:flex; align-items:center; gap:12px; }
.brand .logo{ width:44px; height:44px; border-radius: 11px; object-fit: cover; }
.brand .title{ margin:0; font-weight:800; font-size: var(--fs-20); letter-spacing:.2px; }
.brand .sub{ margin:2px 0 0; color:var(--muted); font-size: var(--fs-14); }
.tools{ display:flex; gap:.5rem; }
.tools a{
  text-decoration:none; color:inherit; border:1px solid var(--line); background:transparent;
  padding:.5rem .85rem; border-radius:999px; font-weight:700; font-size: var(--fs-14);
}

/* ===== Chat panel ===== */
.chat{
  margin-top: 14px; border-radius: var(--r-lg);
  background: var(--panel); border:1px solid var(--line); box-shadow: var(--shadow-2);
  overflow:hidden;
}
.bar{ display:flex; gap:.35rem; align-items:center; flex-wrap:wrap; padding:10px 12px;
  border-bottom:1px solid var(--line); background: linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.03));
}
.dot{ width:22px; height:22px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center;
  font:700 var(--fs-12)/1 Inter, sans-serif; color:var(--muted); border:1px solid var(--line);
}
.dot:last-child{ color:var(--ink); border-color: rgba(14,165,233,.35); }

.feed{ padding: 12px; }

/* ===== Messages ===== */
.msg{ display:flex; align-items:flex-start; gap:10px; margin:12px 0; }
.avatar{
  width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:800;
  background:#e6f7f5; color:#0b7666; border:1px solid var(--line); font-size: 14px; flex:0 0 auto;
}
.msg.user .avatar{ background:#eef1f5; color:#222; }

.bubble{
  max-width: 100%; border-radius: var(--r); border:1px solid var(--line); background:var(--panel);
  box-shadow: 0 1px 0 rgba(2,8,23,.03); padding:12px 14px; line-height:1.6; font-size: var(--fs-16);
}
.bubble .title{ font-weight:800; margin-bottom:8px; font-size: var(--fs-18); }

/* ===== Cards (options) – responsive grid, rapide, jolis ===== */
.list{ margin-top: 10px; }
.grid{
  display:grid; gap:10px;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); /* 1–3 colonnes selon largeur */
}
.card{
  display:flex; align-items:center; gap:12px; border-radius: 14px; padding: 14px 16px;
  background: var(--chip); border:1px solid var(--line);
  text-decoration:none; color:inherit; font-weight:800; font-size: var(--fs-16);
  transform: translateY(4px) scale(.98); opacity:0; /* reveal animé */
  will-change: transform, opacity;
}
.card.reveal{ opacity:1; transform: translateY(0) scale(1); transition: transform .18s ease, opacity .18s ease; }
.card:hover{ box-shadow: var(--shadow-1); transform: translateY(-1px) scale(1.01); transition: transform .18s ease, box-shadow .18s ease; }
.card:active{ transform: translateY(0) scale(1); }

.ic{
  width:34px; height:34px; border-radius:10px; display:flex; align-items:center; justify-content:center;
  background:#e9f7f1; color:#0f6e55; border:1px solid var(--line); flex:0 0 auto;
}
.txt{
  flex:1 1 auto; min-width:0;
  /* >>> Le texte ne se coupe plus mal sur mobile : */
  white-space: normal; word-break: normal; overflow-wrap: anywhere; hyphens: auto;
  line-height: 1.35;
}
.arr{ color: var(--muted); flex:0 0 auto; }

/* ===== Bottom actions ===== */
.actions{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top: 10px; }
.btn{
  text-decoration:none; color:inherit; border:1px solid var(--line); background:transparent;
  padding:.5rem .85rem; border-radius:999px; font-weight:700; font-size: var(--fs-14);
}

/* ===== Contact card ===== */
.contact{
  display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center;
  border:1px solid var(--line); border-radius: 14px; padding: 14px; margin-top: 12px; background: var(--panel);
  box-shadow: 0 10px 26px rgba(0,0,0,.06);
}
.contact .ava{
  width:52px; height:52px; border-radius: 12px; display:flex; align-items:center; justify-content:center;
  background:#e8faf5; color:#0b7666; font-weight:800; border:1px solid var(--line); font-size: 18px;
}
.contact .name{ font-weight:800; font-size: var(--fs-16); }
.contact .meta{ color:var(--muted); font-size: var(--fs-14); }
.contact .cta{
  text-decoration:none; color:#fff; background: linear-gradient(90deg, #10a37f, #2bb3a1);
  padding:.65rem 1rem; border-radius:999px; font-weight:800; font-size: var(--fs-14); border:0;
}

/* Mobile: pile + bouton plein largeur */
@media (max-width: 640px){
  .contact{ grid-template-columns: 1fr; }
  .contact .cta{ width: 100%; text-align:center; }
}

/* Note */
.note{ color:var(--muted); font-size: var(--fs-14); padding: 10px 12px; border-top:1px solid var(--line); }

/* Accessibilité */
@media (prefers-reduced-motion: reduce){
  .card{ transition:none !important; transform:none !important; opacity:1 !important; }
}
</style>
</head>

<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <img src="doggygo.png" class="logo" alt="">
        <div>
          <p class="title">Doggygo</p>
          <p class="sub">Assistant du Service de la recherche</p>
        </div>
      </div>
      <div class="tools" id="top-tools" style="display:none">
        <a id="back" href="javascript:goback();" style="display:none">← Retour</a>
        <a id="restart" href="javascript:location.reload()" style="display:none">⟲ Recommencer</a>
      </div>
    </header>

    <section class="chat">
      <div class="bar" id="progress" aria-live="polite"></div>
      <div class="feed" id="feed" aria-live="polite" aria-label="Flux de conversation"></div>
      <div class="note"><i class="fa-regular fa-circle-question"></i> Les liens de contact pointent vers l’annuaire UNIL.</div>
    </section>
  </div>

<script>
/* =========================================================
   JS — Quartz Grid
   - Turbo par défaut (pas de typing lent)
   - Option reveal très rapide des cartes (stagger)
   - Compatible format/goback + JSON ./trees/papago-*.json
   ========================================================= */

/* ---------- Réglages vitesse ---------- */
const SETTINGS = {
  TYPING_ENABLED: false,   // false = turbo (texte instantané)
  TYPE_CHAR_MS: 10,        // si TYPING_ENABLED=true
  CARD_STAGGER_MS: 50      // reveal ultra-rapide des cartes
};

/* ---------- Données de base ---------- */
var lang = "fr";
var papagoUrl = "./trees/";

var persons = {
  "EAM" : { "name": "Eliane Abou Mansour", "url": "https://annuaire.unil.ch/person/LgLLf7wep3kZBi" },
  "VL"  : { "name": "Véronique Longchamp",  "url": "https://annuaire.unil.ch/person/u5rsd2fbRe7LFH" },
  "AEDC": { "name": "Anne-Emmanuelle de Crousaz", "url": "https://annuaire.unil.ch/person/R87FcLkKew3U7p" },
  "AB"  : { "name": "Aurélie Brehmer",     "url": "https://annuaire.unil.ch/person/hk2dAGXkGb4U5w" },
  "CA"  : { "name": "Claire Arnold",        "url": "https://annuaire.unil.ch/person/47c7LgpckuHb25" },
  "ZEM" : { "name": "Zohra El Masbahi",     "url": "https://annuaire.unil.ch/person/KGKZjmZikDrmpw" },
  "ACB" : { "name": "Anne-Christine Butty", "url": "https://annuaire.unil.ch/person/LjB3d7wep3kZBi" },
  "MD"  : { "name": "Maëlle Desard",        "url": "https://annuaire.unil.ch/person/hkifyGXkGb4U5w" },
  "PAD" : { "name": "Pablo Andrés Diaz",    "url": "https://annuaire.unil.ch/person/pfFzXB2bjLZnA4" },
  "TVL" : { "name": "Thé Van Luong",        "url": "https://annuaire.unil.ch/person/cmbpD4u7m9XUBj" },
  "MC"  : { "name": "Micaela Crespo",       "url": "https://annuaire.unil.ch/person/cKu9p4u7m9XUBj" },
  "LC"  : { "name": "Lucia Couto",          "url": "https://annuaire.unil.ch/person/p9L8fB2bjLZnA4" },
  "JR"  : { "name": "Julian Randall",       "url": "https://annuaire.unil.ch/person/R4rszLkKew3U7p" }
};

var translate = { 
  "fr" : { "contact": "Contacter", "text" : "La personne ci‑dessous peut vous conseiller directement.", "error" : "Doggygo n'est pas accessible pour le moment." },
  "en" : { "contact": "Contact", "text" : "The person below can advise you directly.", "error" : "Doggygo is not available at the moment." }
};

/* ---------- État ---------- */
var papago = {};
var currentKey = "", parentKey = "", atContact = false, backFromContact = "";
var trail = [];

/* ---------- Helpers DOM ---------- */
const $ = s => document.querySelector(s);
function setHTML(target, html){ (typeof target==="string" ? $(target) : target).innerHTML = html; }
function show(el){ el.style.display=""; }
function hide(el){ el.style.display="none"; }
function escapeHTML(str){ const d=document.createElement('div'); d.textContent=String(str||""); return d.innerHTML; }
function initials(name){ if(!name) return "?"; const p=name.trim().split(/\s+/); return ((p[0]?.[0]||"")+(p[1]?.[0]||"")).toUpperCase()||"?"; }
function scrollToBottom(){ requestAnimationFrame(()=>window.scrollTo({top:document.body.scrollHeight, behavior:"smooth"})); }

/* ---------- Progress ---------- */
function renderProgress(){
  const el = $("#progress"); if(!el) return;
  if(trail.length===0){ el.innerHTML=""; return; }
  el.innerHTML = trail.map((_,i)=>`<span class="dot">${i+1}</span>`).join("");
}

/* ---------- Messages ---------- */
function addAssistantBubble(){
  const item = document.createElement('div');
  item.className = "msg assistant";
  item.innerHTML = `
    <div class="avatar" aria-hidden="true">🐾</div>
    <div class="bubble">
      <div class="text"></div>
      <div class="list"></div>
    </div>`;
  $("#feed").appendChild(item); scrollToBottom(); return item;
}
function addUserBubble(text){
  const item = document.createElement('div');
  item.className = "msg user";
  item.innerHTML = `<div class="avatar" aria-hidden="true"></div><div class="bubble">${escapeHTML(text)}</div>`;
  $("#feed").appendChild(item); scrollToBottom(); return item;
}

/* ---------- Typing (optionnel) ---------- */
function typeText(el, text, ms){
  if(!SETTINGS.TYPING_ENABLED || ms<=0 || window.matchMedia('(prefers-reduced-motion: reduce)').matches){
    el.textContent = text; return Promise.resolve();
  }
  return new Promise(resolve=>{
    let i=0; const len=text.length, span=document.createElement('span'); el.appendChild(span);
    (function loop(){ if(i<len){ span.textContent += text.charAt(i++); setTimeout(loop, ms); } else resolve(); })();
  });
}

/* ---------- Options ---------- */
function createCard(opt){
  const a = document.createElement('a');
  a.href="javascript:void(0)"; a.className="card";
  a.setAttribute("data-label", opt.option);
  a.innerHTML = `
      <div class="ic"><i class="fa-solid fa-bolt"></i></div>
      <div class="txt">${escapeHTML(opt.option)}</div>
      <div class="arr"><i class="fa-solid fa-chevron-right"></i></div>`;
  a.onclick = ()=> choose(opt.value, opt.option, a);
  return a;
}

function revealCards(grid){
  const cards = Array.from(grid.children);
  cards.forEach((c,idx)=> setTimeout(()=> c.classList.add('reveal'), idx*SETTINGS.CARD_STAGGER_MS));
}

/* ---------- Rendu questions / contact ---------- */
async function renderOptions(key){
  const node = papago[key] || {};
  const label = String(node.label||"");
  parentKey = node.parent || "";
  currentKey = key; atContact = false;

  if(trail[trail.length-1] !== key) trail.push(key);
  renderProgress();

  const msg = addAssistantBubble();
  await typeText(msg.querySelector('.text'), label, SETTINGS.TYPE_CHAR_MS);

  const list = msg.querySelector('.list');
  const grid = document.createElement('div'); grid.className="grid"; list.appendChild(grid);

  (node.options || []).forEach(opt => grid.appendChild(createCard(opt)));
  revealCards(grid);

  // actions bas
  const actions = document.createElement('div'); actions.className="actions";
  if(node.parent){
    const back = document.createElement('a'); back.className="btn"; back.href="javascript:goback()"; back.textContent="← Retour"; actions.appendChild(back);
  }
  msg.querySelector('.bubble').appendChild(actions);

  show($("#top-tools"));
  node.parent ? show($("#back")) : hide($("#back"));
  hide($("#restart"));
  scrollToBottom();
}

async function renderContact(value){
  // "Contacter CODE"
  const parts = value.split(" ");
  const code = parts[1];
  const p = persons[code] || {};
  const name = p.name || code || "Contact";
  const url = p.url || "#";

  backFromContact = currentKey; atContact = true;
  if(trail[trail.length-1] !== "contact:"+code) trail.push("contact:"+code);
  renderProgress();

  const msg = addAssistantBubble();
  await typeText(msg.querySelector('.text'), translate[lang]["text"], SETTINGS.TYPE_CHAR_MS);

  const card = document.createElement('div');
  card.className = "contact";
  card.innerHTML = `
    <div class="ava">${initials(name)}</div>
    <div>
      <div class="name">${escapeHTML(name)}</div>
      <div class="meta"><i class="fa-regular fa-address-card"></i> UNIL · Service de la recherche</div>
    </div>
    <div><a class="cta" target="_blank" rel="noopener" href="${url}"><i class="fa-solid fa-paper-plane"></i> ${escapeHTML(translate[lang]["contact"])}</a></div>`;
  msg.querySelector('.text').appendChild(card);

  const actions = document.createElement('div'); actions.className="actions";
  const back = document.createElement('a'); back.className="btn"; back.href="javascript:goback()"; back.textContent="← Retour"; actions.appendChild(back);
  const restart = document.createElement('a'); restart.className="btn"; restart.href="javascript:location.reload()"; restart.textContent="⟲ Recommencer"; actions.appendChild(restart);
  msg.querySelector('.bubble').appendChild(actions);

  show($("#top-tools")); show($("#back")); show($("#restart"));
  scrollToBottom();
}

/* ---------- Choix ---------- */
function choose(value, label, card){
  // lock cartes de la même question
  const grid = card.parentElement; Array.from(grid.children).forEach(c=>{ c.style.pointerEvents="none"; c.style.opacity=.6; });

  // bulle utilisateur immédiate (turbo)
  addUserBubble(label);

  setTimeout(()=> {
    (String(value).substr(0,9) === "Contacter") ? renderContact(String(value)) : renderOptions(String(value));
  }, 40);
}

/* ---------- API publique ---------- */
function format(item){ (item.substr(0,9)==="Contacter") ? renderContact(item) : renderOptions(item); }
function goback(){
  if(atContact && backFromContact){
    if(trail[trail.length-1] && String(trail[trail.length-1]).startsWith("contact:")) trail.pop();
    setHTML("#feed",""); format(backFromContact); return;
  }
  if(!parentKey) return;
  trail.pop(); setHTML("#feed",""); format(parentKey);
}
window.format = format; window.goback = goback;

/* ---------- Boot ---------- */
function loadParams(){
  const params = new URLSearchParams(location.search);
  const qLang = params.get("lang"); const notitle = params.get("notitle");
  if(qLang && translate[qLang]) lang = qLang;
  if(notitle === "true"){ document.querySelector('.header').style.display="none"; }
}
async function boot(){
  loadParams();
  try{
    const res = await fetch(papagoUrl + "papago-" + lang + ".json", {cache:"no-store"});
    papago = await res.json();
    show($("#top-tools"));
    format("0");
  }catch(e){
    console.error(e);
    const msg = addAssistantBubble();
    msg.querySelector('.text').innerHTML = `<div role="alert" style="color:#b42318;font-weight:600;margin:0">⚠ ${translate[lang]["error"]}</div>`;
    show($("#top-tools")); hide($("#back")); show($("#restart"));
  }
}
document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
