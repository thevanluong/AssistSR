<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Doggygo · AssistSR2</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

<style>
/* =========================================================
   PRISM WAVE — dark glass + neon accents (mobile-first)
   ========================================================= */
:root{
  color-scheme: dark light;

  /* Palette (dark-first) */
  --bg: #0b1020;                 /* nuit bleutée */
  --panel: rgba(18,22,34,.78);   /* verre sombre */
  --ink: #e9eefc;
  --muted: #9fb0d0;
  --line: rgba(255,255,255,.12);
  --chip: rgba(255,255,255,.06);

  /* Accents néon */
  --a1: #22f0b5;   /* menthe */
  --a2: #7b5cff;   /* violet */
  --a3: #ffb970;   /* ambre */

  /* Light mode (si besoin) */
  --bg-light: #f6f7fb;
  --panel-light: rgba(255,255,255,.9);
  --ink-light: #101625;
  --muted-light: #667089;
  --line-light: rgba(15,23,42,.14);
  --chip-light: rgba(15,23,42,.04);

  /* Rayons / tailles / ombres */
  --r: 14px; --r-lg: 18px;
  --fs-13: clamp(12.5px, .85vw, 13.5px);
  --fs-15: clamp(13.5px, 1vw, 15px);
  --fs-16: clamp(14px, 1.05vw, 16px);
  --fs-18: clamp(16px, 1.25vw, 18px);
  --fs-20: clamp(17px, 1.45vw, 20px);
  --shadow-1: 0 12px 32px rgba(8,12,24,.28);
  --shadow-2: 0 22px 70px rgba(8,12,24,.32);
}

@media (prefers-color-scheme: light){
  :root{
    --bg: var(--bg-light);
    --panel: var(--panel-light);
    --ink: var(--ink-light);
    --muted: var(--muted-light);
    --line: var(--line-light);
    --chip: var(--chip-light);
  }
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; color:var(--ink);
  font: 400 var(--fs-16)/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Inter,Roboto,Arial,sans-serif;
  background:
    radial-gradient(60vw 40vh at 20% -10%, rgba(123,92,255,.15), transparent 65%),
    radial-gradient(60vw 40vh at 95% 0%, rgba(34,240,181,.12), transparent 58%),
    radial-gradient(70vw 45vh at -10% 70%, rgba(255,185,112,.10), transparent 65%),
    var(--bg);
  padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
  -webkit-font-smoothing: antialiased;
}

.container{
  max-width: 1240px;            /* occupe bien l’espace sur desktop */
  margin: 0 auto;
  padding: clamp(14px, 3.2vw, 28px);
}

/* ===== Header ===== */
.header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.brand{ display:flex; align-items:center; gap:12px; }
.logo{ width:44px; height:44px; border-radius: 10px; object-fit: cover; }
.brand .title{ margin:0; font-weight:800; letter-spacing:.2px; font-size: var(--fs-20); }
.brand .sub{ margin:2px 0 0; color:var(--muted); font-size: var(--fs-15); }

.tools{ display:flex; gap:.55rem; }
.tools a{
  text-decoration:none; color:inherit; border:1px solid var(--line);
  padding:.55rem .9rem; border-radius:999px; font-weight:700; font-size: var(--fs-15);
  backdrop-filter: saturate(120%) blur(6px);
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
}

/* ===== Chat panel (verre + bordure dégradée) ===== */
.chat{
  margin-top: 16px; border-radius: var(--r-lg);
  background:
    linear-gradient(var(--panel), var(--panel)) padding-box,
    linear-gradient(120deg, rgba(34,240,181,.45), rgba(123,92,255,.35), rgba(255,185,112,.45)) border-box;
  border: 1px solid transparent;
  box-shadow: var(--shadow-2);
  overflow: clip; backdrop-filter: saturate(140%) blur(8px);
}

.bar{
  display:flex; gap:.35rem; align-items:center; flex-wrap:wrap; padding: 10px 12px;
  border-bottom: 1px solid var(--line);
  background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.15));
}
.dot{
  width:22px; height:22px; border-radius: 999px; display:inline-flex; align-items:center; justify-content:center;
  font:700 var(--fs-13)/1 Inter, sans-serif; color:var(--muted);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border: 1px solid var(--line);
}
.dot:last-child{
  color: var(--ink);
  border-image: linear-gradient(120deg, var(--a1), var(--a2), var(--a3)) 1;
  border-width: 1px; border-style: solid;
}

.feed{ padding: 12px; }

/* ===== Messages ===== */
.msg{ display:flex; align-items:flex-start; gap:10px; margin: 12px 0; }
.avatar{
  width:28px; height:28px; border-radius: 8px; display:flex; align-items:center; justify-content:center; font-weight:800;
  background: linear-gradient(180deg, rgba(34,240,181,.18), rgba(123,92,255,.18));
  color:#0bfcce; border: 1px solid var(--line); font-size: 14px; flex:0 0 auto;
}
.msg.user .avatar{
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); color:#d4dbf5;
}

.bubble{
  max-width: 100%; border-radius: var(--r);
  background:
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)) padding-box,
    linear-gradient(90deg, rgba(34,240,181,.35), rgba(123,92,255,.25), transparent 70%) border-box;
  border: 1px solid transparent;
  box-shadow: 0 1px 0 rgba(2,8,23,.25);
  padding: 12px 14px; line-height: 1.6; font-size: var(--fs-16);
}
.bubble .title{ font-weight:800; margin-bottom:8px; font-size: var(--fs-18); }

/* ===== Cards (options) — grille large et dynamique ===== */
.list{ margin-top: 10px; }
.grid{
  display:grid; gap: 10px;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* 1–3 colonnes */
}
.card{
  display:flex; align-items:center; gap:12px; border-radius: 14px; padding: 14px 16px;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border: 1px solid var(--line);
  text-decoration:none; color:inherit; font-weight:800; font-size: var(--fs-16);
  transform: translateY(6px) scale(.985); opacity:0;
  /* micro glow gauche */
  position: relative; overflow: hidden;
}
.card::before{
  content:""; position:absolute; left:-2px; top:0; bottom:0; width:4px;
  background: linear-gradient(180deg, var(--a1), var(--a2), var(--a3)); opacity:.35;
  filter: blur(.4px);
}
.card.reveal{
  opacity:1; transform: translateY(0) scale(1);
  transition: transform .18s ease, opacity .18s ease;
}
.card:hover{ box-shadow: var(--shadow-1); transform: translateY(-1px) scale(1.01); transition: transform .18s ease, box-shadow .18s ease; }
.card:active{ transform: translateY(0) scale(1); }

.ic{
  width:34px; height:34px; border-radius: 10px; display:flex; align-items:center; justify-content:center;
  background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  color:#0bfcce; border: 1px solid var(--line); flex:0 0 auto;
}
.txt{
  flex:1 1 auto; min-width:0;
  white-space: normal; word-break: normal; overflow-wrap: anywhere; hyphens: auto; /* propre sur mobile */
  line-height: 1.35;
}
.arr{ color: var(--muted); flex:0 0 auto; }

/* ===== Bottom actions ===== */
.actions{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top: 10px; }
.btn{
  text-decoration:none; color:inherit; border:1px solid var(--line);
  padding:.5rem .85rem; border-radius:999px; font-weight:700; font-size: var(--fs-15);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
}

/* ===== Contact ===== */
.contact{
  display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center;
  border:1px solid var(--line); border-radius: 14px; padding: 14px; margin-top: 12px;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  box-shadow: 0 12px 30px rgba(0,0,0,.18);
}
.contact .ava{
  width:52px; height:52px; border-radius: 12px; display:flex; align-items:center; justify-content:center;
  background: linear-gradient(180deg, rgba(34,240,181,.22), rgba(123,92,255,.18));
  color:#0bfcce; font-weight:800; border:1px solid var(--line); font-size: 18px;
}
.contact .name{ font-weight:800; font-size: var(--fs-16); }
.contact .meta{ color:var(--muted); font-size: var(--fs-15); }
.contact .cta{
  text-decoration:none; color:#07151b;
  background: linear-gradient(90deg, var(--a1), var(--a3));
  padding:.65rem 1rem; border-radius:999px; font-weight:800; font-size: var(--fs-15); border:0;
  box-shadow: 0 12px 26px rgba(34,240,181,.25);
}
@media (max-width: 640px){
  .contact{ grid-template-columns: 1fr; }
  .contact .cta{ width:100%; text-align:center; }
}

/* Note */
.note{ color:var(--muted); font-size: var(--fs-15); padding: 10px 12px; border-top:1px solid var(--line); }

/* Accessibilité */
@media (prefers-reduced-motion: reduce){
  .card{ transition: none !important; transform:none !important; opacity:1 !important; }
}
</style>
</head>

<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <img src="doggygo.png" class="logo" alt="">
        <div>
          <p class="title">Doggygo</p>
          <p class="sub">Assistant du Service de la recherche</p>
        </div>
      </div>
      <div class="tools" id="top-tools" style="display:none">
        <a id="back" href="javascript:goback();" style="display:none">← Retour</a>
        <a id="restart" href="javascript:location.reload()" style="display:none">⟲ Recommencer</a>
      </div>
    </header>

    <section class="chat">
      <div class="bar" id="progress" aria-live="polite"></div>
      <div class="feed" id="feed" aria-live="polite" aria-label="Flux de conversation"></div>
      <div class="note"><i class="fa-regular fa-circle-question"></i> Les liens de contact pointent vers l’annuaire UNIL.</div>
    </section>
  </div>

<script>
/* =========================================================
   PRISM WAVE – JS
   - Streaming rapide (questions, réponses, finale)
   - Cartes tapées PAR MOTS, en PARALLÈLE (stagger)
   - Remplit toute la largeur sur desktop, propre sur mobile
   ========================================================= */

/* ---------- Réglages ---------- */
const SPEED = {
  CHAR_MS: 8,        // frappe par caractère (questions / réponses utilisateur)
  WORD_MS: 40,       // frappe par mot (cartes)
  STAGGER_MS: 35     // décalage entre cartes (wow rapide)
};

/* ---------- Données ---------- */
var lang = "fr";
var papagoUrl = "./trees/";

var persons = {
  "EAM" : { "name": "Eliane Abou Mansour", "url": "https://annuaire.unil.ch/person/LgLLf7wep3kZBi" },
  "VL"  : { "name": "Véronique Longchamp",  "url": "https://annuaire.unil.ch/person/u5rsd2fbRe7LFH" },
  "AEDC": { "name": "Anne-Emmanuelle de Crousaz", "url": "https://annuaire.unil.ch/person/R87FcLkKew3U7p" },
  "AB"  : { "name": "Aurélie Brehmer",     "url": "https://annuaire.unil.ch/person/hk2dAGXkGb4U5w" },
  "CA"  : { "name": "Claire Arnold",        "url": "https://annuaire.unil.ch/person/47c7LgpckuHb25" },
  "ZEM" : { "name": "Zohra El Masbahi",     "url": "https://annuaire.unil.ch/person/KGKZjmZikDrmpw" },
  "ACB" : { "name": "Anne-Christine Butty", "url": "https://annuaire.unil.ch/person/LjB3d7wep3kZBi" },
  "MD"  : { "name": "Maëlle Desard",        "url": "https://annuaire.unil.ch/person/hkifyGXkGb4U5w" },
  "PAD" : { "name": "Pablo Andrés Diaz",    "url": "https://annuaire.unil.ch/person/pfFzXB2bjLZnA4" },
  "TVL" : { "name": "Thé Van Luong",        "url": "https://annuaire.unil.ch/person/cmbpD4u7m9XUBj" },
  "MC"  : { "name": "Micaela Crespo",       "url": "https://annuaire.unil.ch/person/cKu9p4u7m9XUBj" },
  "LC"  : { "name": "Lucia Couto",          "url": "https://annuaire.unil.ch/person/p9L8fB2bjLZnA4" },
  "JR"  : { "name": "Julian Randall",       "url": "https://annuaire.unil.ch/person/R4rszLkKew3U7p" }
};
var translate = {
  "fr" : { "contact": "Contacter", "text" : "La personne ci‑dessous peut vous conseiller directement.", "error" : "Doggygo n'est pas accessible pour le moment." },
  "en" : { "contact": "Contact", "text" : "The person below can advise you directly.", "error" : "Doggygo is not available at the moment." }
};

/* ---------- État ---------- */
var papago = {};
var currentKey = "", parentKey = "", atContact = false, backFromContact = "";
var trail = [];

/* ---------- Helpers ---------- */
const $ = s => document.querySelector(s);
function setHTML(t, h){ (typeof t==="string" ? $(t) : t).innerHTML = h; }
function show(el){ el.style.display=""; }
function hide(el){ el.style.display="none"; }
function escapeHTML(s){ const d=document.createElement('div'); d.textContent=String(s||""); return d.innerHTML; }
function initials(name){ if(!name) return "?"; const p=name.trim().split(/\s+/); return ((p[0]?.[0]||"")+(p[1]?.[0]||"")).toUpperCase()||"?"; }
function scrollToBottom(){ requestAnimationFrame(()=>window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" })); }
function reduced(){ return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; }

/* ---------- Progress ---------- */
function renderProgress(){
  const el = $("#progress"); if(!el) return;
  if(trail.length===0){ el.innerHTML=""; return; }
  el.innerHTML = trail.map((_,i)=>`<span class="dot">${i+1}</span>`).join("");
}

/* ---------- Messages ---------- */
function addAssistantBubble(){
  const item = document.createElement('div');
  item.className = "msg assistant";
  item.innerHTML = `
    <div class="avatar" aria-hidden="true">🐾</div>
    <div class="bubble">
      <div class="text"></div>
      <div class="list"></div>
    </div>`;
  $("#feed").appendChild(item); scrollToBottom(); return item;
}
function addUserBubble(){
  const item = document.createElement('div');
  item.className = "msg user";
  item.innerHTML = `<div class="avatar" aria-hidden="true"></div><div class="bubble"><span class="typed"></span></div>`;
  $("#feed").appendChild(item); scrollToBottom(); return item;
}

/* ---------- Typing ---------- */
function typeChars(el, text, ms){
  if(reduced()){ el.textContent=text; return Promise.resolve(); }
  return new Promise(resolve=>{
    const span=document.createElement('span'); el.appendChild(span);
    let i=0; (function loop(){ if(i<text.length){ span.textContent += text.charAt(i++); setTimeout(loop, ms); scrollToBottom(); } else resolve(); })();
  });
}
function typeWords(el, text, ms){
  if(reduced()){ el.textContent=text; return Promise.resolve(); }
  const tokens = text.match(/\S+\s*/g) || [];
  return new Promise(resolve=>{
    const span=document.createElement('span'); el.appendChild(span);
    let i=0; (function loop(){ if(i<tokens.length){ span.textContent += tokens[i++]; setTimeout(loop, ms); scrollToBottom(); } else resolve(); })();
  });
}

/* ---------- Options ---------- */
function createCard(opt){
  const a = document.createElement('a');
  a.href="javascript:void(0)"; a.className="card"; a.title = opt.option; a.setAttribute('aria-label', opt.option);
  a.innerHTML = `
    <div class="ic"><i class="fa-solid fa-bolt"></i></div>
    <div class="txt"></div>
    <div class="arr"><i class="fa-solid fa-chevron-right"></i></div>`;
  a.onclick = ()=> choose(opt.value, opt.option, a);
  return a;
}
function revealAndTypeCards(grid, options){
  const cards = [];
  options.forEach((opt, i)=>{
    const card = createCard(opt);
    grid.appendChild(card);
    cards.push({card, label: opt.option, idx:i});
  });

  // Révélation rapide (stagger) + typage par mots en parallèle
  cards.forEach(({card, label, idx})=>{
    setTimeout(()=>{
      card.classList.add('reveal');
      typeWords(card.querySelector('.txt'), label, SPEED.WORD_MS);
    }, idx * SPEED.STAGGER_MS);
  });
}

/* ---------- Rendu étapes ---------- */
async function renderOptions(key){
  const node = papago[key] || {};
  const label = String(node.label || "");
  parentKey = node.parent || ""; currentKey = key; atContact = false;

  if(trail[trail.length-1] !== key) trail.push(key);
  renderProgress();

  const msg = addAssistantBubble();
  await typeChars(msg.querySelector('.text'), label, SPEED.CHAR_MS);

  const list = msg.querySelector('.list');
  const grid = document.createElement('div'); grid.className="grid"; list.appendChild(grid);
  revealAndTypeCards(grid, node.options || []);

  const actions = document.createElement('div'); actions.className="actions";
  if(node.parent){
    const back = document.createElement('a'); back.className="btn"; back.href="javascript:goback()"; back.textContent="← Retour"; actions.appendChild(back);
  }
  msg.querySelector('.bubble').appendChild(actions);

  show($("#top-tools"));
  node.parent ? show($("#back")) : hide($("#back"));
  hide($("#restart"));
  scrollToBottom();
}

async function renderContact(value){
  const parts = value.split(" ");
  const code = parts[1];
  const p = persons[code] || {};
  const name = p.name || code || "Contact";
  const url = p.url || "#";

  backFromContact = currentKey; atContact = true;
  if(trail[trail.length-1] !== "contact:"+code) trail.push("contact:"+code);
  renderProgress();

  const msg = addAssistantBubble();
  await typeChars(msg.querySelector('.text'), translate[lang]["text"], SPEED.CHAR_MS);

  const card = document.createElement('div');
  card.className = "contact";
  card.innerHTML = `
    <div class="ava">${initials(name)}</div>
    <div>
      <div class="name">${escapeHTML(name)}</div>
      <div class="meta"><i class="fa-regular fa-address-card"></i> UNIL · Service de la recherche</div>
    </div>
    <div><a class="cta" target="_blank" rel="noopener" href="${url}"><i class="fa-solid fa-paper-plane"></i> ${escapeHTML(translate[lang]["contact"])}</a></div>`;
  msg.querySelector('.text').appendChild(card);

  const actions = document.createElement('div'); actions.className="actions";
  const back = document.createElement('a'); back.className="btn"; back.href="javascript:goback()"; back.textContent="← Retour"; actions.appendChild(back);
  const restart = document.createElement('a'); restart.className="btn"; restart.href="javascript:location.reload()"; restart.textContent="⟲ Recommencer"; actions.appendChild(restart);
  msg.querySelector('.bubble').appendChild(actions);

  show($("#top-tools")); show($("#back")); show($("#restart"));
  scrollToBottom();
}

/* ---------- Choix ---------- */
async function choose(value, label, card){
  // Désactive les cartes de la même question
  const grid = card.parentElement; Array.from(grid.children).forEach(c=>{ c.style.pointerEvents="none"; c.style.opacity=.65; });

  // Réponse utilisateur (rapide)
  const user = addUserBubble();
  await typeChars(user.querySelector('.typed'), label, SPEED.CHAR_MS);

  setTimeout(()=> {
    (String(value).substr(0,9) === "Contacter") ? renderContact(String(value)) : renderOptions(String(value));
  }, 40);
}

/* ---------- API publique ---------- */
function format(item){ (item.substr(0,9)==="Contacter") ? renderContact(item) : renderOptions(item); }
function goback(){
  if(atContact && backFromContact){
    if(trail[trail.length-1] && String(trail[trail.length-1]).startsWith("contact:")) trail.pop();
    setHTML("#feed",""); format(backFromContact); return;
  }
  if(!parentKey) return;
  trail.pop(); setHTML("#feed",""); format(parentKey);
}
window.format = format; window.goback = goback;

/* ---------- Boot ---------- */
function loadParams(){
  const params = new URLSearchParams(location.search);
  const qLang = params.get("lang"); const notitle = params.get("notitle");
  if(qLang && translate[qLang]) lang = qLang;
  if(notitle === "true"){ document.querySelector('.header').style.display="none"; }
}
async function boot(){
  loadParams();
  try{
    const res = await fetch(papagoUrl + "papago-" + lang + ".json", {cache:"no-store"});
    papago = await res.json();
    show($("#top-tools"));
    format("0");
  }catch(e){
    console.error(e);
    const msg = addAssistantBubble();
    msg.querySelector('.text').innerHTML = `<div role="alert" style="color:#ff8a8a;font-weight:700;margin:0">⚠ ${translate[lang]['error']}</div>`;
    show($("#top-tools")); hide($("#back")); show($("#restart"));
  }
}
document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
