<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Doggygo ¬∑ AssistSR2</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<!-- Bootstrap (utilitaires) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

<style>
/* =========================================================
   LINEAR GLOW XL ‚Äî grand, premium, wow discret & lisible
   ========================================================= */
:root{
  color-scheme: light dark;

  /* Dimensions */
  --radius: 16px;       /* bulles */
  --radius-lg: 22px;    /* panneaux */
  --radius-xl: 20px;    /* cartes r√©ponses */
  --speed: .22s;

  /* Palette (Light) */
  --bg: #f6f7fb;
  --panel: #ffffff;
  --text: #0b1220;
  --muted: #64748b;
  --border: #e7e8ef;
  --chip: #f2f4f8;

  /* Palette (Dark) */
  --bg-dark: #0e1117;
  --panel-dark: #0f131a;
  --text-dark: #e9edf3;
  --muted-dark: #9aa3af;
  --border-dark: #242a33;
  --chip-dark: #151b22;

  /* Accent (d√©grad√© chic) */
  --accent-1: #10a37f;
  --accent-2: #2bb3a1;

  /* Ombres */
  --shadow-1: 0 12px 28px rgba(18, 24, 40, .08);
  --shadow-2: 0 26px 64px rgba(18, 24, 40, .12);
}

@media (prefers-color-scheme: dark){
  :root{
    --bg: var(--bg-dark);
    --panel: var(--panel-dark);
    --text: var(--text-dark);
    --muted: var(--muted-dark);
    --border: var(--border-dark);
    --chip: var(--chip-dark);
  }
}

*{ box-sizing: border-box; }
html,body{ height:100%; }
body{
  margin:0; color:var(--text);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;

  /* fond aurora sobre */
  background:
    radial-gradient(1100px 560px at 75% -10%, rgba(16,163,127,.10), transparent 70%),
    radial-gradient(1000px 500px at -10% 10%, rgba(10,163,200,.08), transparent 60%),
    var(--bg);
}
body::before{
  content:""; position: fixed; inset: -20% -20% auto -20%; height: 50vh;
  background:
    radial-gradient(42% 100% at 20% 0%, rgba(16,163,127,.16), transparent 60%),
    radial-gradient(42% 100% at 80% 0%, rgba(10,163,200,.12), transparent 60%);
  filter: blur(30px) saturate(115%); opacity:.75; pointer-events: none;
  animation: aurora 28s ease-in-out infinite alternate;
}
@keyframes aurora{ from{ transform: translate3d(-2%,0,0);} to{ transform: translate3d(2%,2%,0);} }

.app-shell{
  max-width: 1160px;     /* nettement plus large */
  margin: 0 auto;
  padding: clamp(18px, 3.6vw, 32px);
}

/* En-t√™te ample */
.header{
  display:flex; align-items:center; justify-content:space-between; gap:14px;
  padding: 6px 0 8px 0;
}
.brand{ display:flex; align-items:center; gap:12px; }
.logo{ width:52px; height:52px; border-radius: 12px; object-fit: cover; }
.h-title{ margin:0; font-weight:800; font-size: 22px; letter-spacing:.2px; }
.h-sub{ margin:2px 0 0; color: var(--muted); font-size: 14px; }

.toolbar{ display:flex; gap:.6rem; }
.toolbar .btn{
  border-radius: 999px; padding:.6rem 1rem; font-weight:700; font-size: 14px;
  background: transparent; border: 1px solid var(--border); color: inherit;
  transition: transform var(--speed), box-shadow var(--speed), background var(--speed);
}
.toolbar .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-1); }
.toolbar .btn:focus{ box-shadow: 0 0 0 .2rem rgba(16,163,127,.22); }

/* Trait d‚Äôaccent */
.accent-line{
  height: 3px; width: 100%;
  background: linear-gradient(90deg, transparent, rgba(16,163,127,.35), transparent);
  background-size: 200% 100%;
  animation: shift 22s linear infinite; border-radius: 2px; opacity:.9;
}
@keyframes shift{ 0%{background-position:0 0;} 100%{background-position:200% 0;} }

/* Panneau principal */
.chat-wrap{
  margin-top: 16px;
  border-radius: var(--radius-lg);
  background:
    linear-gradient(var(--panel), var(--panel)) padding-box,
    linear-gradient(120deg, var(--border), rgba(16,163,127,.36), var(--border)) border-box;
  border: 1px solid transparent;
  box-shadow: var(--shadow-2);
  position: relative; overflow: clip;
}

/* Progress chips */
.progress-chips{
  display:flex; gap:.45rem; align-items:center; flex-wrap:wrap;
  padding: 16px; border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,.03));
}
.chip{
  width:28px; height:28px; border-radius: 999px; font-weight:800; font-size:13px;
  display:inline-flex; align-items:center; justify-content:center;
  color: var(--muted); background: transparent; border: 1px solid var(--border);
}
.chip:last-child{ color: var(--text); border-color: rgba(16,163,127,.45); }

/* Zone chat */
#chat{ padding: 16px; }

/* Messages */
.msg{
  display:flex; align-items:flex-start; gap:14px; margin: 16px 0;
  animation: rise var(--speed) ease-out;
}
@keyframes rise{ from{opacity:0; transform: translateY(6px);} to{opacity:1; transform: translateY(0);} }
.msg .avatar{
  width:40px; height:40px; border-radius: 12px; flex: 0 0 auto;
  display:flex; align-items:center; justify-content:center; font-weight:800; font-size: 18px;
  background: linear-gradient(180deg, #d5f5eb, #bfeee0); color:#064e3b;
  border:1px solid var(--border);
}
.msg.user .avatar{ opacity:.75; background: linear-gradient(180deg, #eceff3, #e5e9ee); color:#222; }
.msg .bubble{
  max-width: 980px; position: relative;
  border-radius: var(--radius); padding: 18px 20px;
  border: 1px solid var(--border); background: var(--panel);
  line-height: 1.65; font-size: 18px;
}
.msg .bubble::after{
  content:""; position:absolute; left:16px; right:16px; top:0; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(16,163,127,.35), transparent);
  opacity:.7;
}
.msg.user .bubble{ background: color-mix(in oklab, var(--panel) 86%, var(--bg) 14%); }

/* Caret de frappe */
.caret{
  display:inline-block; width: 8px; height: 1.05em; vertical-align: -0.2em;
  border-right: 2px solid rgba(16,163,127,.85); margin-left: 2px;
  animation: blink .9s steps(1) infinite;
}
@keyframes blink{ 0%, 100%{opacity:0;} 50%{opacity:1;} }

/* Titre bulle */
.msg .bubble .title{ font-weight: 800; margin-bottom: 10px; letter-spacing:.2px; font-size: 20px; }

/* ===== Cartes r√©ponses (grandes, dynamiques, multilignes) ===== */
.choices{ margin-top: 12px; }
.choices-grid{
  display:grid; gap: 12px;
  grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); /* 1‚Äì3 colonnes selon largeur */
  grid-auto-rows: minmax(80px, auto); /* hauteur auto si multi-lignes */
}
.opt-card{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding: 18px 20px; border-radius: var(--radius-xl);
  background: var(--chip);
  border: 1px solid var(--border);
  text-decoration:none; color: inherit; font-weight: 800; font-size: 18px;
  transition: transform var(--speed), box-shadow var(--speed), background var(--speed), border-color var(--speed);
  position: relative; overflow: hidden; min-height: 80px;
}
.opt-left{ display:flex; align-items:center; gap:14px; min-width:0; flex: 1 1 auto; }
.opt-ico{
  width:42px; height:42px; border-radius: 12px; display:flex; align-items:center; justify-content:center;
  background: linear-gradient(180deg, #eaf8f3, #dff3ec); color:#0e6d56; border: 1px solid var(--border);
  flex: 0 0 auto; font-size: 18px;
}
.opt-text{
  /* >>> Fix: jamais tronqu√©, multilignes <<< */
  display:block; flex: 1 1 auto;
  white-space: normal;
  overflow: visible;
  word-break: break-word;
  overflow-wrap: anywhere;
  line-height: 1.35;
}
.opt-arrow{ flex: 0 0 auto; opacity: 0; transition: opacity var(--speed); font-size: 18px; }
.opt-card:hover{
  background:
    linear-gradient(var(--chip), var(--chip)) padding-box,
    linear-gradient(120deg, rgba(16,163,127,.45), rgba(16,163,127,.15)) border-box;
  border-color: transparent; transform: translateY(-1px);
  box-shadow: var(--shadow-1);
}
.opt-card.typed .opt-arrow{ opacity: 1; }

/* Actions bas de bulle */
.bottom-actions{ display:flex; gap:.6rem; flex-wrap: wrap; margin-top: 14px; }
.btn-ghost{
  border-radius: 999px; padding:.6rem 1rem; font-weight:700; font-size: 15px;
  background: transparent; border: 1px solid var(--border); color: inherit; text-decoration:none;
  transition: transform var(--speed), box-shadow var(--speed), background var(--speed);
}
.btn-ghost:hover{ transform: translateY(-1px); box-shadow: var(--shadow-1); }
.btn-ghost:focus{ box-shadow: 0 0 0 .2rem rgba(16,163,127,.22); }
.btn-accent{
  border-radius: 999px; padding:.8rem 1.2rem; font-weight:800; font-size: 15px;
  background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
  color: #fff; border: 1px solid transparent; text-decoration:none;
  box-shadow: 0 14px 34px rgba(16,163,127,.25);
}

/* Carte contact */
.contact-card{
  display:grid; grid-template-columns: auto 1fr auto; gap:16px; align-items:center;
  border-radius: calc(var(--radius) + 4px);
  padding: 16px; margin-top: 16px;
  background:
    linear-gradient(var(--panel), var(--panel)) padding-box,
    linear-gradient(120deg, rgba(16,163,127,.45), rgba(16,163,127,.15)) border-box;
  border: 1px solid transparent;
  box-shadow: 0 12px 30px rgba(0,0,0,.08);
  min-width: 0; transform: translateY(6px) scale(.98); opacity:0;
  animation: cardIn .28s ease-out forwards;
}
@keyframes cardIn{ to{ transform: translateY(0) scale(1); opacity:1; } }
.contact-card .avatar{
  width:56px; height:56px; border-radius: 12px; display:flex; align-items:center; justify-content:center;
  font-weight:800; background: #e5f5ef; color:#065f46; border: 1px solid var(--border); font-size: 18px;
}
.contact-card .name{ font-weight:800; font-size: 17px; }
.contact-card .meta{ color: var(--muted); font-size: 14px; word-break: break-word; }
.contact-card .btn-accent{ min-width: 0; }

/* Mobile : pile + bouton plein largeur */
@media (max-width: 720px){
  .choices-grid{ grid-template-columns: 1fr; }  /* 1 carte par ligne sur mobile */
  .contact-card{ grid-template-columns: 1fr; }
  .contact-card .btn-accent{ width: 100%; }
}

/* Note */
.note{ color: var(--muted); font-size: 13px; padding: 14px 16px; border-top: 1px solid var(--border); }

/* Accessibilit√© */
.visually-hidden{ position:absolute !important; width:1px; height:1px; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); border:0; }
@media (prefers-reduced-motion: reduce){
  *{ animation: none !important; transition: none !important; }
}
</style>
</head>

<body>
  <main class="app-shell">
    <header class="header">
      <div class="brand">
        <img src="doggygo.png" alt="" class="logo" />
        <div>
          <p class="h-title">Doggygo</p>
          <p class="h-sub">Assistant du Service de la recherche</p>
        </div>
      </div>
      <div class="toolbar" id="buttons" style="display:none">
        <a id="back" href="javascript:goback();" class="btn" style="display:none; text-decoration:none">
          <i class="fa-solid fa-chevron-left"></i> Retour
        </a>
        <a id="restart" href="javascript:location.reload()" class="btn" style="display:none; text-decoration:none">
          <i class="fa-solid fa-rotate-left"></i> Recommencer
        </a>
      </div>
    </header>
    <div class="accent-line" aria-hidden="true"></div>

    <section class="chat-wrap">
      <div id="progress" class="progress-chips" aria-live="polite"></div>
      <div id="chat" aria-live="polite" aria-label="Flux de conversation"></div>
      <div class="note">
        <i class="fa-regular fa-circle-question"></i> Les liens de contact pointent vers l‚Äôannuaire UNIL.
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* ======================================================
     Logique : questions + r√©ponses dynamiques (multilignes)
     ====================================================== */

  // ===== Donn√©es (inchang√©es) =====
  var lang = "fr";
  var papagoUrl = "./trees/";
  var persons = {
    "EAM" : { "name": "Eliane Abou Mansour", "url": "https://annuaire.unil.ch/person/LgLLf7wep3kZBi" },
    "VL"  : { "name": "V√©ronique Longchamp",  "url": "https://annuaire.unil.ch/person/u5rsd2fbRe7LFH" },
    "AEDC": { "name": "Anne-Emmanuelle de Crousaz", "url": "https://annuaire.unil.ch/person/R87FcLkKew3U7p" },
    "AB"  : { "name": "Aur√©lie Brehmer",     "url": "https://annuaire.unil.ch/person/hk2dAGXkGb4U5w" },
    "CA"  : { "name": "Claire Arnold",        "url": "https://annuaire.unil.ch/person/47c7LgpckuHb25" },
    "ZEM" : { "name": "Zohra El Masbahi",     "url": "https://annuaire.unil.ch/person/KGKZjmZikDrmpw" },
    "ACB" : { "name": "Anne-Christine Butty", "url": "https://annuaire.unil.ch/person/LjB3d7wep3kZBi" },
    "MD"  : { "name": "Ma√´lle Desard",        "url": "https://annuaire.unil.ch/person/hkifyGXkGb4U5w" },
    "PAD" : { "name": "Pablo Andr√©s Diaz",    "url": "https://annuaire.unil.ch/person/pfFzXB2bjLZnA4" },
    "TVL" : { "name": "Th√© Van Luong",        "url": "https://annuaire.unil.ch/person/cmbpD4u7m9XUBj" },
    "MC"  : { "name": "Micaela Crespo",       "url": "https://annuaire.unil.ch/person/cKu9p4u7m9XUBj" },
    "LC"  : { "name": "Lucia Couto",          "url": "https://annuaire.unil.ch/person/p9L8fB2bjLZnA4" },
    "JR"  : { "name": "Julian Randall",       "url": "https://annuaire.unil.ch/person/R4rszLkKew3U7p" }
  };
  var translate = { 
    "fr" : {
        "contact": "Contacter",
        /* >>> Majuscule exig√©e <<< */
        "text" : "La personne ci‚Äëdessous peut vous conseiller directement.",
        "error" : "Doggygo n'est pas accessible pour le moment."
    },
    "en" : {
        "contact": "Contact",
        "text" : "The person below can advise you directly.",
        "error" : "Doggygo is not available at the moment."
    }
  };

  // ===== √âtat =====
  var papago = {};
  var currentKey = "";
  var parentKey = "";
  var trail = [];
  var atContact = false;
  var backTargetFromContact = "";

  // ===== Helpers =====
  function $(sel){ return document.querySelector(sel); }
  function setHTML(idOrEl, html){ (typeof idOrEl === 'string' ? $(idOrEl) : idOrEl).innerHTML = html; }
  function show(el){ el.style.display = ""; }
  function hide(el){ el.style.display = "none"; }
  function escapeHTML(str){ var d=document.createElement('div'); d.textContent=String(str||""); return d.innerHTML; }
  function initials(name){ if(!name) return "?"; var p=name.trim().split(/\s+/); return ((p[0]?.[0]||"")+(p[1]?.[0]||"")).toUpperCase()||"?"; }
  function scrollToBottom(){ requestAnimationFrame(function(){ window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }); }); }
  function renderProgress(){
    var el = $("#progress");
    if(!el) return;
    if(trail.length === 0){ el.innerHTML = ""; return; }
    el.innerHTML = trail.map(function(_, i){ return '<span class="chip">'+(i+1)+'</span>'; }).join('');
  }

  // ===== Messages =====
  function addAssistantBubble(){
    var wrap = document.createElement('div');
    wrap.className = "msg assistant";
    wrap.innerHTML =
      '<div class="avatar" aria-hidden="true">üêæ</div>'+
      '<div class="bubble"><div class="text"></div><div class="choices"></div></div>';
    $("#chat").appendChild(wrap); scrollToBottom(); return wrap;
  }
  function addUserBubble(){
    var wrap = document.createElement('div');
    wrap.className = "msg user";
    wrap.innerHTML = '<div class="avatar" aria-hidden="true"></div><div class="bubble"><span class="typed" style="word-break:break-word; overflow-wrap:anywhere;"></span></div>';
    $("#chat").appendChild(wrap); scrollToBottom(); return wrap;
  }

  /* Typage rapide avec caret (si non reduced-motion) */
  function typeStream(el, text, speed){
    var reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if(reduce || speed <= 0){ el.textContent = text; return Promise.resolve(); }
    return new Promise(function(resolve){
      var typedSpan = document.createElement('span');
      var caret = document.createElement('span'); caret.className = 'caret';
      el.appendChild(typedSpan); el.appendChild(caret);
      var i=0, len=text.length;
      (function loop(){
        if(i < len){
          typedSpan.textContent += text.charAt(i++);
          var ch = typedSpan.textContent.slice(-1);
          var s = (ch === ' ' || ch === '\n') ? speed * 0.6 : speed;
          setTimeout(loop, s); scrollToBottom();
        }else{ caret.remove(); resolve(); }
      })();
    });
  }
  async function streamAssistantMessage(text){
    var bubble = addAssistantBubble();
    await typeStream(bubble.querySelector('.text'), text, 11);
    return bubble;
  }
  async function streamUserMessage(text){
    var bubble = addUserBubble();
    await typeStream(bubble.querySelector('.typed'), text, 9);
    return bubble;
  }

  // ===== Cartes d‚Äôoptions dynamiques (texte tap√© √† l‚Äôint√©rieur) =====
  function createOptionCard(opt, onChoose){
    var a = document.createElement('a');
    a.href = "javascript:void(0)";
    a.className = "opt-card";
    a.innerHTML =
      '<div class="opt-left">'+
        '<div class="opt-ico"><i class="fa-solid fa-bolt"></i></div>'+
        '<div class="opt-text" aria-live="polite"></div>'+
      '</div>'+
      '<div class="opt-arrow"><i class="fa-solid fa-chevron-right"></i></div>';
    a.onclick = function(){ onChoose(opt.value, opt.option, a); };
    return a;
  }

  async function typeOptionsSequentially(cards, speed){
    // Tape chaque carte l‚Äôune apr√®s l‚Äôautre (vrai ‚Äúdynamique‚Äù)
    for(const card of cards){
      var el = card.querySelector('.opt-text');
      var label = card.getAttribute('data-label') || "";
      await typeStream(el, label, speed);
      card.classList.add('typed'); // fait appara√Ætre la fl√®che
    }
  }

  function addBottomActions(bubble, opts){
    var actions = document.createElement('div');
    actions.className = "bottom-actions";
    if(opts.showBack){
      var backBtn = document.createElement('a');
      backBtn.href = "javascript:goback()";
      backBtn.className = "btn-ghost";
      backBtn.innerHTML = '<i class="fa-solid fa-chevron-left"></i> Retour';
      actions.appendChild(backBtn);
    }
    if(opts.showRestart){
      var restartBtn = document.createElement('a');
      restartBtn.href = "javascript:location.reload()";
      restartBtn.className = "btn-ghost";
      restartBtn.innerHTML = '<i class="fa-solid fa-rotate-left"></i> Recommencer';
      actions.appendChild(restartBtn);
    }
    bubble.querySelector('.bubble').appendChild(actions);
  }

  // ===== √âtapes =====
  async function renderOptions(key){
    var node = papago[key] || {};
    var label = String(node.label || "");
    parentKey = node.parent || "";
    currentKey = key;
    atContact = false;

    if(trail[trail.length-1] !== key){ trail.push(key); }
    renderProgress();

    var bubble = await streamAssistantMessage(label);

    // Grille de cartes
    var choicesWrap = document.createElement('div');
    choicesWrap.className = "choices";
    var grid = document.createElement('div');
    grid.className = "choices-grid";
    choicesWrap.appendChild(grid);
    bubble.querySelector('.bubble').appendChild(choicesWrap);

    // Cr√©e les cartes (texte vide au d√©part)
    var cards = [];
    (node.options || []).forEach(function(opt){
      var card = createOptionCard(opt, chooseOption);
      card.setAttribute('data-label', opt.option);
      grid.appendChild(card);
      cards.push(card);
    });

    // Tape le texte **dans** les cartes (s√©quentiel)
    await typeOptionsSequentially(cards, 9);

    // Actions bas de bulle
    addBottomActions(bubble, { showBack: !!node.parent, showRestart: false });

    // Toolbar top
    show($("#buttons"));
    if(node.parent){ show($("#back")); } else { hide($("#back")); }
    hide($("#restart"));
    scrollToBottom();
  }

  async function renderContact(item){
    // "Contacter CODE"
    var clean = item.replace("Contacter", translate[lang]["contact"]);
    var parts = clean.split(" ");
    var code = parts[1];
    var p = persons[code] || {};
    var name = p.name || code || "Contact";
    var url = p.url || "#";

    backTargetFromContact = currentKey;
    atContact = true;

    if(trail[trail.length-1] !== "contact:"+code){ trail.push("contact:"+code); }
    renderProgress();

    // Message final EXACT demand√© (tap√©)
    var bubble = await streamAssistantMessage(translate[lang]["text"]);

    // Carte contact
    var card = document.createElement('div');
    card.className = "contact-card";
    card.innerHTML =
      '<div class="avatar" aria-hidden="true">'+ initials(name) +'</div>'+
      '<div>'+
        '<div class="name">'+ escapeHTML(name) +'</div>'+
        '<div class="meta"><i class="fa-regular fa-address-card"></i> UNIL ¬∑ Service de la recherche</div>'+
      '</div>'+
      '<div>'+
        '<a class="btn-accent" target="_blank" rel="noopener" href="'+ url +'">'+
          '<i class="fa-solid fa-paper-plane"></i> '+ escapeHTML(translate[lang]["contact"]) +
        '</a>'+
      '</div>';
    bubble.querySelector('.text').appendChild(card);

    addBottomActions(bubble, { showBack: true, showRestart: true });

    show($("#buttons")); show($("#back")); show($("#restart"));
    scrollToBottom();
  }

  async function chooseOption(value, text, currentCard){
    // D√©sactive toutes les cartes pour √©viter le double-clic
    var grid = currentCard.closest('.choices-grid');
    grid.querySelectorAll('.opt-card').forEach(function(c){ c.style.pointerEvents = "none"; c.style.opacity = .6; });

    // Affiche la r√©ponse utilisateur en streaming (multiligne OK)
    await streamUserMessage(text);

    setTimeout(function(){
      if(String(value).substr(0,9) === "Contacter"){ renderContact(String(value)); }
      else{ renderOptions(String(value)); }
    }, 60);
  }

  // API publique (compat)
  function format(item){ if(item.substr(0,9) === "Contacter"){ renderContact(item); } else { renderOptions(item); } }
  function goback(){
    if(atContact && backTargetFromContact){
      if(trail[trail.length-1] && String(trail[trail.length-1]).startsWith("contact:")) trail.pop();
      setHTML("#chat", ""); format(backTargetFromContact); return;
    }
    if(!parentKey) return;
    trail.pop(); setHTML("#chat", ""); format(parentKey);
  }
  window.format = format; window.goback = goback;

  // ===== Boot =====
  function loadParams(){
    var params = new URLSearchParams(location.search);
    var qLang = params.get("lang");
    var notitle = params.get("notitle");
    if(qLang && translate[qLang]) lang = qLang;
    if(notitle === "true"){
      document.querySelectorAll(".brand, .toolbar, .accent-line").forEach(function(h){ h.classList.add("visually-hidden"); });
    }
  }
  async function boot(){
    loadParams();
    try{
      var res = await fetch(papagoUrl + "papago-" + lang + ".json", {cache:"no-store"});
      papago = await res.json();
      show($("#buttons"));
      format("0");
    }catch(e){
      console.error(e);
      var wrap = addAssistantBubble();
      wrap.querySelector('.text').innerHTML =
        '<div class="alert alert-danger mb-0" role="alert">'+
        '<i class="fa-solid fa-triangle-exclamation"></i> '+ translate[lang]['error'] +'</div>';
      show($("#buttons")); hide($("#back")); show($("#restart"));
    }
  }
  document.addEventListener("DOMContentLoaded", boot);
  </script>
</body>
</html>
